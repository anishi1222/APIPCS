# APIポリシー実装の作成

*APIの作成*と呼ばれることが多々ありますが、実は、設計、文書化、サービスの実装、ポリシーの実装など、多くの作業があります。ここでは、APIマネージャーとして、APIを作成し定義する方法について説明します。この時点から、デプロイメント、公開、プロモーション、アクセス許可など、他のすべての活動がスタートします。おそらくこれが*APIの作成*と呼ばれる理由です。

## 始める前に

1. API Platform Cloud Serviceの環境があります。 API Platform Cloud Serviceの環境調達の詳細については、[環境](../../../../environments/README.md)を参照してください。
2. 演習[APIの設計](../../../design/design_api)を完了している必要があります。

## APIの作成

### API Platform Cloud Serviceにログイン

1. 選択した環境の説明に従って、ブラウザで管理ポータルのURLをアクセスします。

    > このURLは、選択した[環境](../../../environments/README.md)に基づいていますが、形式は `http(s)://<host>:<port>/apiplatform`です。

2. *APIマネージャー*ロールを持つユーザーとしてログインします。

### APIの新規作成

1. *API*メニューが表示されていることを確認します。API一覧が表示され、右側に*作成*ボタンが表示されるはずです。表示されていない場合は、左側のメニューボタンを選択し、*API*を選択してください。
1. *作成*ボタンをクリックします。
1. *TicketService*のような名前とAPIのバージョンを指定します。また、説明を入力することもできます。

    > 共有環境を使用している場合は、APIがすでに作成されている可能性があります。自分の名前の頭文字を付けるようにAPIの名前を変更して、どのAPIが自分のものであるかを知ることができます。

APIを作成すると、APIのリストにそのAPIが表示されます。API名をクリックして編集を続行してください。

#### 仕様の選択

  > 注：*Apiary Free*プランをご利用の場合、このオプションは利用できません。実装にリンクするAPIは、チームに属している必要があります。 APIがApiaryのチームで所有していない場合は、この手順をスキップできます。

*仕様*タブ（左側）では、Apiaryで[APIの設計](../../../design/design_api)の演習で作成したAPI設計を選択できます。

#### ポリシー実装の選択と設定

*API実装*タブ（左側）には、リクエストとレスポンスパイプラインが表示されます。リクエストパイプラインから、*APIリクエスト*と*サービス・リクエスト*が表示されます。

- APIリクエストは、APIを使用する開発者がリクエストを送信する場所です。このエンドポイントは、APIがデプロイされているゲートウェイ上に存在します。後でAPIをデプロイします。
- サービス・リクエストは、バックエンドサービスの場所です。すべてのポリシー条件が満たされている場合、これはゲートウェイがリクエストを渡す場所です。

##### APIリクエストの設定

APIリクエストは、APIのリクエストが送信されるエンドポイントです。リクエストが送信される完全なアドレスは、使用されるプロトコル、ゲートウェイホスト名、APIリクエストエンドポイント、およびサービスで使用可能なプライベートリソースパスで構成されます。

例：`http://<host>:<port>/ticketService/1/tickets`

ここで：

- `http`は、ゲートウェイがリクエストを受信するプロトコルです。
- `<host>:<port>`は、このAPIがデプロイされているゲートウェイインスタンスのホスト名とポートです。
- `ticketService/1`は、選択したAPIエンドポイントです（現在は`/API名/バージョン`としてハードコードされています）。
- `/tickets`は、APIのプライベートリソースパスと見なされます。 APIエンドポイントを超えるものは、バックエンドサービスに渡されます。

APIリクエストを設定するには：

1. APIリクエストポリシーにカーソルを置き、*編集*をクリックします。
1. *ポリシーの編集*ダイアログで、次のフィールドを入力します。
1. リクエストに関するコメントを追加します（オプション）。
1. *プロトコル*リストから*HTTP*を選択します。これは、ゲートウェイがこのAPIのリクエストを受信するプロトコルです。
1. *APIエンドポイントURL*を入力します。たとえば、ticketService/1（apiName/version）です。すでに使用されているエンドポイントを選択した場合は、自分の名前の頭文字を追加してエンドポイントを一意にします（例：rw/ticketService/1）
1. 終了したら、*適用*をクリックします。

##### サービス・リクエストの設定

サービス・リクエストは、バックエンドサービスがリクエストを受信するURLまたはエンドポイントです。リクエストがすべてのポリシー条件を満たすと、ゲートウェイはリクエストをこのURLにルーティングし、サービスを呼び出します。

サービス・リクエストURLは、ベースURLだけでなく、サービスのリソースのいずれかを指すことができます。この方法では、APIのリソースのサブセットのみにアクセスするようにユーザーを制限できます。

サービス・リクエストを設定するには、まず、サービス・リクエストポリシーにカーソルを置き、*編集*をクリックします。

URLを直接入力するか、既存のサービスを参照することができます。これが最初のAPIの場合は、URLを直接入力してください。

1. ポリシーの編集ダイアログで、*URLを入力*を選択します。
1. [APIの設計](../../../design/design_api)のApiaryモックサービスURLをに入力します。
1. モックサービスのURLから*/tickets*を削除すると、APIは*/incident*などの複数のエンドポイントを呼び出すように設計できます。
1. *サービスアカウント*をなしのままにします。
1. ゲートウェイが企業ファイアウォールの背後にある場合は、*ゲートウェイ・ノード・プロキシの使用*がオンになっていることを確認してください。
1. *適用*をクリックします。
1. *保存*をクリックします。

###### サービスの参照

API Platform Cloud Serviceでは、サービスを登録することもできます。これは、複数のAPIのサービスから参照する場合や、バックエンドサービスとAPIを処理するメンバーが異なる場合に適しています。バックエンドサービスのエンドポイントをサービスとしてAPI Platform Cloud Serviceに登録することで、APIマネージャにAPIで参照できるようになりますが、実際のエンドポイントは表示されません。

認証済みアクセスを提供したい場合、サービスにサービスアカウントを付加することもできますが、実際の資格情報は共有しません。

既に作成済みのサービスを使用する場合は、利用可能なサービスのリストから選択するだけです。

最初のAPIを作成する場合は、URLに直接入力するだけで問題ありません。

## リクエストとレスポンスの流れを理解する

この演習では、簡単なリクエストフローを構成しました。ポリシー定義には、*リクエスト*と*レスポンス*ヘッダータブが表示されます。

*レスポンス*タブをクリックして、レスポンスフローのトップダウン視覚表現を表示します。利用可能なポリシーも変わることがわかります。*サービス・レスポンス*および*APIレスポンス*は編集できません。

レスポンスフローでは、サービス・レスポンスが最初に発生します。バックエンドサービスからのレスポンスは常にアウトバウンドフローの最初のエントリです。このフローに追加のポリシーを配置できます。ポリシーは、レスポンスがクライアントに送り返されるまで、最上位のポリシーが最初に実行され、次のポリシーが実行され、順番に実行されます。これの一例は、Redactionポリシーです。バックエンドシステムが提供する結果の一部を返さないようにできます。

APIレスポンスエントリは、レスポンスがクライアントに返されたときのアウトバウンドフロー内のポイントを視覚的に表したものです。

## 結論

この演習では、次のことを学びました。

- API Platform Cloud ServiceでAPIを作成する方法
- *リクエスト*と*レスポンス*フローの違い

## もっと詳しく知る

APIの作成の詳細については、[APIの作成](http://www.oracle.com/pls/topic/lookup?ctx=en/cloud/paas/api-platform-cloud&id=GUID-B9691D64-FCD2-4A8C-9DA3-8E29CB48E1E2)のマニュアルをご覧ください。

## 次のステップ

- [APIのデプロイ](../deploy_api)
