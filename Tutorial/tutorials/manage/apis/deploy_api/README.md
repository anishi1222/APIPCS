# APIのデプロイ

APIはゲートウェイにデプロイする必要があります。 APIを正常にデプロイすると、構成したエンドポイントでリクエストを受け取り、正常なリクエストをバックエンドサービスにルーティングします。

## 始める前に

- 利用可能なAPI Platform Cloud Service環境を有している必要があります。API Platform Cloud Service環境の調達の詳細については、[環境](../../../../environments/README.md)を参照してください。
- [APIポリシー実装の作成](../create_api)の演習を完了している必要があります。
  - APIを作成したユーザーの資格情報またはAPIを*デプロイ*または*管理*する適切な資格を持つユーザーの資格情報を持っています。
- お使いの環境に少なくとも1つのゲートウェイがデプロイされており、APIをデプロイするユーザーは、ゲートウェイに[デプロイメントをリクエストする](../../gateways/grants)適切な許可を与えられます。通常、*APIマネージャー*ロールを持つユーザーです。
- [ゲートウェイへのデプロイ](../../gateways/grants)できるユーザーの資格情報があります。通常、*Gateway Manager*ロールを持つユーザーです。

## APIのデプロイ

APIをデプロイするには：

1. APIを作成したユーザーとしてAPI Platform Cloud Service管理ポータルにログインします。
1. デプロイするAPIを選択します。
1. *デプロイメント*タブをクリックします。
1. *APIのデプロイ*をクリックします。
1. ゲートウェイを選択します。
1. *初期デプロイ状態*として*アクティブ*を選択します。
1. （オプション）お好みで説明フィールドを入力します。
1. *デプロイ*をクリックします。

デプロイメントの状態が何であるか観察します。デプロイ済ですか？リクエスト中？待機中？または失敗？

## デプロイメントの完了

APIが*リクエスト中*にある場合、ユーザーは*ゲートウェイへのデプロイメントのリクエスト*権限を持っていますが、*ゲートウェイへのデプロイ*または*ゲートウェイの管理*権限を持っていません。 APIが*待機中*または*デプロイ済*の場合、ユーザーは*ゲートウェイへのデプロイ*または*ゲートウェイの管理*権限を持っています。状態に応じて、適切な次のステップを選択します。

### デプロイメントのリクエスト中

*ゲートウェイへのデプロイメントのリクエスト*権限でAPIをデプロイしようとすると、APIが*リクエスト中*の状態になります。適切な権限を持つユーザーがデプロイメントを承認するまでデプロイされません。

#### デプロイメントの承認

デプロイメントが*リクエスト中*のAPI（すなわち、*デプロイ済*、*待機中*または*失敗*ではない）がある場合、適切な権限を持っているユーザがデプロイメントを承認する必要があります。

1. *ゲートウェイの管理*または*ゲートウェイへのデプロイ*権限を持つユーザーとしてAPI Platform Cloud Serviceにログインします。
1. *ゲートウェイ*を選択します。
1. あなたのゲートウェイを選択します。
1. *デプロイメント*サイドタブを選択します。
1. *リクエスト中*ヘッダータブを選択します。
1. リクエストの詳細を展開し、API実装を確認します。
1. 確認が完了したら、リクエスト上にマウスを移動して*承認*ボタンをクリックします。
1. 展開の承認に関するコメントを追加し、*はい*をクリックします。
1. *リクエスト中*から*待機中*、*デプロイ済*に、リクエストが遷移していることを確認してください。

### デプロイメントが*待機中*または*デプロイ済*

それ以上のアクションはありません。 *待機中*の場合は、自動的に*デプロイ済*に変わるはずです。

## APIのテスト（オプション）

APIがデプロイされたので、お気に入りのRESTクライアントでAPIを呼び出すことができます。

## APIの再デプロイ

デプロイされたAPIは、たとえば変更が行われたときに再デプロイできます。ログインしている人の役割に応じて、このタスクを実行する複数のルートがあります。

### APIマネージャ

*APIマネージャー*ロールを持ち、対象APIの*APIのデプロイ*権限または*APIの管理*権限を持っていて、所望のゲートウェイに少なくとも*ゲートウェイへのデプロイメントのリクエスト*権限を持つ場合、最初に[APIのデプロイ時](#APIのデプロイ)と同じ手順に従って、*APIのデプロイ*ボタンをクリックしてデプロイすることも、デプロイメントのリストでAPIを選択し、そこから*再デプロイ*することもできます。

デプロイメントのリストからAPIを再デプロイするには：

1. APIを作成したユーザーとしてAPI Platform Cloud Service管理ポータルにログインします。
1. デプロイするAPIを選択します。
1. *デプロイメント*タブをクリックします。
1. APIデプロイメントのリストを確認します（*デプロイ済*または*失敗*のトップタブを選択してください）。
1. 再デプロイしたい既存のデプロイメントを選択し、マウスをゲートウェイ名の上に移動します。
1. *再デプロイ*、*非アクティブ化*、*アンデプロイ*の3つのボタンが表示されていることがわかります。
1. *再デプロイ*をクリックします。
1. 再デプロイする反復を選択します。
1. 必要に応じて再デプロイに関するコメントを入力し、*はい*をクリックして選択を確定します。

### ゲートウェイマネージャ

ゲートウェイマネージャーで、特定のAPIのデプロイ権限を持つ人は、APIマネージャーと同じ手順を実行できます。 APIに移動し、そのAPIのデプロイメントを選択する代わりに、ゲートウェイ・マネージャーはゲートウェイに移動し、*デプロイメント*サイド・タブを選択します。その後のワークフローは同じです。

## 結論

このチュートリアルでは、以下の方法を学習しました。

- APIのデプロイ
- APIの再デプロイ
- デプロイメントリクエストの承認