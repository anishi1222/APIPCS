# API Platform Cloud Service Tutorial

## 目次

- [目的](#目的)
- [APIの実装](#APIの実装)
  - [ゲートウェイ管理者としてのログイン](#ゲートウェイ管理者としてのログイン)
  - [ゲートウェイへのデプロイ権限を付与](#ゲートウェイへのデプロイ権限を付与)
  - [API管理者としてのへのログイン](#API管理者としてのへのログイン)
  - [APIの作成](#APIの作成)
  - [エンドポイントの構成](#エンドポイントの構成)
    - [APIリクエストの構成](#APIリクエストの構成)
    - [サービス・リクエストの構成](#サービス・リクエストの構成)
    - [レスポンス・フロー](#レスポンス・フロー)
    - [ゲートウェイへのAPIのデプロイ](#ゲートウェイへのAPIのデプロイ)
    - [デプロイ済APIの呼び出し](#デプロイ済APIの呼び出し)
  - [ポリシーの追加と構成](#ポリシーの追加と構成)
    - [キー検証ポリシーの追加](#キー検証ポリシーの追加)
    - [アプリケーション・レート制限ポリシーの構成](#アプリケーション・レート制限ポリシーの構成)
    - [ヘッダー検証ポリシーの構成](#ヘッダー検証ポリシーの構成)
    - [インターフェース・フィルタリング・ポリシーの構成](#インターフェース・フィルタリング・ポリシーの構成)
    - [リソース・ベース・ルーティング・ポリシーの構成](#リソース・ベース・ルーティング・ポリシーの構成)
    - [サービス・コールアウト・ポリシーの構成](#サービス・コールアウト・ポリシーの構成)
    - [Groovy Scriptポリシーの構成](#groovy-scriptポリシーの構成)
- [APIのデプロイ](#APIのデプロイ)
  - [デプロイメントの権限](#デプロイメントの権限)
  - [APIの再デプロイ](#APIの再デプロイ)
  - [現在のデプロイ済APIの確認](#現在のデプロイ済APIの確認)
  - [APIの有効化・無効化](#APIの有効化無効化)
  - [再デプロイ済APIの呼び出し](#再デプロイ済APIの呼び出し)
  - [APIのアンデプロイ](#APIのアンデプロイ)
- [APIのドキュメンテーションとポータルへの公開](#APIのドキュメンテーションとポータルへの公開)
  - [APIポータルのURLの構成](#APIポータルのurlの構成)
  - [概要テキストの構成](#概要テキストの構成)
  - [ドキュメンテーション・ページの構成](#ドキュメンテーションページの構成)
  - [コンテンツのプレビュー](#コンテンツのプレビュー)
  - [公開、再公開、公開取り消し](#公開再公開公開取り消し)
- [APIに対する権限](#APIに対する権限)
  - [管理](#管理)
  - [詳細情報の閲覧](#詳細情報の閲覧)
  - [公開済み詳細情報の閲覧](#公開済み詳細情報の閲覧)
  - [デプロイ](#デプロイ)
  - [アプリケーションの登録](#アプリケーションの登録)
  - [アプリケーション登録リクエスト](#アプリケーション登録リクエスト)
- [API Catalog](#API-catalog)
  - [APIの発見](#APIの発見)
  - [API Portal](#API-portal)
  - [API Portalドキュメンテーション](#API-portalドキュメンテーション)
- [アプリケーションの作成と登録](#アプリケーションの作成と登録)
  - [アプリケーションの作成](#アプリケーションの作成)
  - [アプリケーションのAPIへの登録](#アプリケーションのAPIへの登録)
  - [アプリケーションで利用登録したAPIの確認](#アプリケーションで利用登録したAPIの確認)
  - [APIを利用登録したアプリケーションの確認](#APIを利用登録したアプリケーションの確認)
  - [Customer Mobile AppをAPIに登録](#customer-mobile-appをAPIに登録)
  - [アプリケーション・キーの発見](#アプリケーションキーの発見)
  - [Draft状態のポリシーを有効化](#draft状態のポリシーを有効化)
  - [APIの再々デプロイ](#APIの再々デプロイ)
  - [登録済みアプリケーションとしてのリクエスト送信](#登録済みアプリケーションとしてのリクエスト送信)
  - [Postman Collectionを使ったリクエストの送信](#postman-collectionを使ったリクエストの送信)
    - [Postmanでの環境設定](#postmanでの環境設定)
    - [Collectionの実行](#Collectionの実行)
  - [アプリケーション登録の保留](#アプリケーション登録の保留)
  - [新しいアプリケーション・キーの再発行](#新しいアプリケーションキーの再発行)
  - [アプリケーションのAPIからの登録解除](#アプリケーションのAPIからの登録解除)
- [分析](#分析)
  - [APIの分析](#APIの分析)
    - [リクエスト件数のグラフ](#リクエスト件数のグラフ)
    - [レスポンス時間のグラフ](#レスポンス時間のグラフ)
    - [ペイロードサイズのグラフ](#ペイロードサイズのグラフ)
    - [リソース毎のリクエスト](#リソース毎のリクエスト)
    - [アプリケーションごとのリクエストのグラフ](#アプリケーションごとのリクエストのグラフ)
    - [拒否リクエスト件数のグラフ](#拒否リクエスト件数のグラフ)
    - [拒否リクエストの分布グラフ](#拒否リクエストの分布グラフ)
    - [その他の分析グラフ](#その他の分析グラフ)
  - [ゲートウェイの分析](#ゲートウェイの分析)

------

## 目的

このチュートリアルは、Oracle API Platform Cloud Serviceの全体感を知ってもらうことを目的としています。

API Platform Cloud Serviceは企業組織がAPIのメリットを最大限に享受するため、アプリケーション開発者向けのサービスを簡単に管理、保護、公開できるように、以下のAPIコンセプトを実現するための革新的なソリューションを提供します。

- セキュリティ
  - 権限を持つAPI利用者のみがアクセス可能なリソースにアクセスできることを保証
  - 基盤に対する潜在的な攻撃からの保護機能を具備
- 分析と洞察
  - APIの発見手段、利用方法、利用者を分析
  - APIエコシステムでの重要な発生事象を把握
- アジリティ
  - リソース、メソッド、フィールドによってインターフェースをスコープ化
  - アプリケーション、API、リソース、計画によるアクセス件数を管理
  - 適切なサービスへリクエストをルーティング

管理者ポータル（管理ポータル）を使ってAPIを管理、保護、公開します。API公開後、アプリケーション開発者は開発者ポータル（開発者ポータル）を使ってAPIを発見、評価、登録、利用します。このチュートリアルでは、サービスの基本機能の多くを包含するEnd-to-Endでの利用シナリオをたどっていきます。

このシナリオでは、ハンズオン参加者はエネルギー会社に勤務している想定とします。この会社は、お客様番号から直近の課金期間の課金情報や利用情報を返すバックエンド・サービスを有しています。この情報を、モバイル開発者にAPIの一つとして公開し、新しいモバイルアプリケーションをお客様に対して開発できるようにしたいと考えています。

API Platform Cloud Serviceの利用者は以下の1個以上のペルソナに分類されます。

<table>
<tbody>
<tr><th>ロール</th><th>概要</th><th>このTutorialでのユーザー名</th></tr>
<tr>
<td>API Manager<br />
（API管理者）</td>
<td>APIやアプリケーションの登録を管理する（通常、ゲートウェイへのAPIのデプロイをリクエスト）。<br>分析データを要求しAPIの性能状況やいつ、どのようにAPIリクエストに問題が発生したか、どのアプリケーションがAPIにアクセスしているかを確認する。</td><td>api-manager-user</td>
</tr>
<tr>
<td>Service Manager<br />
（サービス管理者）</td>
<td>バックエンドサービスの接続アカウントやURLを構成・管理する。</td><td>service-manager-user</td>
</tr>
<tr>
<td>Gateway Manager<br />
（ゲートウェイ管理者）</td>
<td>ゲートウェイとデプロイ済のAPIを作成、管理する（通常ハードウェア管理者もしくはDevOps管理者）。<br>ゲートウェイのデプロイメント権限を管理する。分析データを要求し、ゲートウェイの性能を確認する。</td><td>api-gateway-user</td>
</tr>
<td>Gateway Runtime User<br />
（ゲートウェイランタイムユーザー）</td>
<td>ゲートウェイ・ノードがManagement Serviceと接続する際に利用するユーザー。</td><td>gateway-runtime-user</td>
</tr>
<td>Plan Manager<br />
（プラン管理者）</td>
<td>レートリミット・プランを作成・管理する。</td><td>api-gateway-user</td>
</tr>
<tr>
<td>Application Developer<br />
（アプリケーション開発者）</td>
<td>ゲートウェイにデプロイされたAPIを発見、登録し、アプリケーションで利用する。<br>開発者ポータルを使ってアプリケーションで利用可能なAPIを探索する。<br>分析データを使って、登録したAPIの性能や、エラーや拒否されたリクエストの件数を確認する。</td><td>app-dev-user</td>
</tr>
<td>Administrator<br />
（管理者）</td>
<td>API Platform Cloud Service全体を管理する責任を負うユーザー。</td><td>api-admin-user</td>
</tr>
</tbody>
</table>

このチュートリアルでは、ハンズオン参加者はAPI管理者、ゲートウェイ管理者、アプリケーション開発者の役回りで作業していきます。このドキュメントの流れに沿って進める際に、タスクを完了するためにこれらのどのロールとして振る舞うべきかを説明します。本番運用では、こうしたロールには別の人に割り当てられることが通常であることにご注意ください。

このチュートリアルでは以下の内容を取り扱います。

1. APIの実装
2. APIのデプロイ
3. APIのドキュメンテーションとポータルへの公開
4. APIに対する権限
5. APIカタログ
6. アプリケーションの登録
7. 分析

------

## APIの実装

この章では、APIの実装方法を学びます。APIの実装作業は以下の作業で構成されています。

1. ゲートウェイ管理者へのログイン
2. ゲートウェイへのデプロイ権限を付与
3. APIの作成
4. エンドポイントの構成
5. ポリシーの追加と構成

### ゲートウェイ管理者としてのログイン

管理者ポータルにゲートウェイ管理者ロールのユーザーとしてログインします。

1. 以下のURLにブラウザからアクセスします。

```bash
<APIPCS URL>/APIplatform
```

2. 以下の資格証明でログインします。

<table><tbody>
<tr><td>ユーザー名</td><td>ゲートウェイ管理者ロールに属するユーザー(api-gateway-user)</td></tr>
<tr><td>パスワード</td><td>当該ユーザーのパスワード</td></tr>
</tbody></table>

> ゲートウェイ管理者としてログインしたので、ゲートウェイsタブのみ表示されているはずです。

### ゲートウェイへのデプロイ権限を付与

ゲートウェイ管理者としてAPI管理者ユーザーに対しゲートウェイへのデプロイ権限を付与します。この結果、再デプロイ時に毎回ユーザーを切り替えなくてもゲートウェイにデプロイできるようになります。不具合を回避するため、View All Detailsの権限も同じユーザーに付与します。これらの権限がデプロイメント・ワークフローに及ぼす影響の詳細は、3.1デプロイメントの権限で確認いただきます。

以下の手順に従って、API管理者 Userに対しAPIデプロイの権限を付与します。

1. ゲートウェイsタブで、［Production ゲートウェイ］をクリック
2. **Users**タブをクリック
3. **View All Details**をクリック
4. **Add Grantee**をクリック
5. **API-manager-user**を選択して［Add］をクリック
6. **Deploy to ゲートウェイ**をクリック
7. **Add Grantee**をクリック
8. **API-manager-user**を選択して［Add］をクリック
9. **API-gateway-user**をクリックしてユーザーメニューを展開し、Sign Outをクリックして管理者ポータルからログアウトする

![image1](./media/image1.png)

### API管理者としてのへのログイン

以後のチュートリアルは、API管理者ロールとして実施します。API管理者はAPIの実装、管理の責任を有しています。

管理者ポータルにAPI管理者ロールでログインします。

1. 以下のURLにブラウザからアクセスします。

```bash
<APIPCS URL>/APIplatform
```

2. 以下の資格証明でログインします。このユーザーはAPI管理者ロールに属しているので、APIsとApplications、ゲートウェイのタブが表示されています。

<table><tbody>
<tr><td>ユーザー名</td><td>API管理者ロールに属するユーザー(API-manager-user)</td></tr>
<tr><td>パスワード</td><td>当該ユーザーのパスワード</td></tr>
</tbody></table>

### APIの作成

それでは、最初のAPIを作成していきましょう。

以下の手順に従って、APIを作成します。

1. APIタブで、［Create New API］をクリック
2. API Nameに**Energy**を指定
3. Versionは**1**
4. （オプション）Descriptionに何か説明を入れてもよい
5. ［Create］をクリック

![image2](./media/image2.png)

### エンドポイントの構成

エンドポイントとは、APIがリクエストやレスポンスを送受信する場所です。API Platform Cloud ServiceのAPIにはリクエストフローに2個のエンドポイント（**APIリクエスト**と**サービス・リクエスト**）があります。

| リクエスト | 概要                                                                                 |
| --------------- | -------------------------------------------------------------------------------- |
| APIリクエスト     | APIを利用する開発者がリクエストを送信するためのエンドポイント。このエンドポイントはAPIがデプロイされるゲートウェイにある。後のチュートリアルでAPIをデプロイする。 |
| サービス・リクエスト | バックエンド・サービスのエンドポイント。すべてのポリシー条件が適う場合に、ゲートウェイがリクエストを通してこのエンドポイントへリクエストを送信する。       |

#### APIリクエストの構成

APIリクエストは、ユーザーやアプリケーションがリクエストをAPIに送信するためのエンドポイントです。リクエストを送信する完全な宛先は、使用プロトコル、ゲートウェイのホスト名、APIのリクエスト・エンドポイント、サービスで利用可能な任意のプライベート・リソース・パスから構成されています。以下の例を考えます。

[http://APIcs.oracle.com:8001/Energy/1/estimate/4859634](http://APIcs.oracle.com:8001/Energy/1/estimate/4859634)

それぞれの意味づけは以下の通りです。

| 項目                              | 意味                                                           |
| ----------------------------- | ---------------------------------------------------------- |
| http                          | ゲートウェイがリクエストを受け取るプロトコル                                     |
| http://APIcs.oracle.com:8001/ | このAPIがデプロイされている、ゲートウェイ・インスタンスのホスト名とポート番号                   |
| Energy/1/                     | 選択したAPIエンドポイント（この例では、**/{API名}/{APIバージョン}**でハードコーディングされている |
| /estimate/4859634             | APIのプライベート・リソース・パス。APIエンドポイントの先のバックエンド・サービスへ渡される。          |

以下の手順に従ってAPIリクエストを構成します。

1. APIsタブで、先ほど作成した**Energy**というAPIをクリック
2. APIリクエスト Policyの上をマウスでホバーリングし、Editをクリック

    > ［注意］
    >
    > ポップアップブロッカーが原因でApply Policyダイアログが現れないことがありますので、その場合はポップアップブロッカーを無効化して再度試してください。

    ![image3](./media/image3.png)

3. Edit Policyダイアログで、以下のように設定し、［Apply］をクリックする。

<table>
<tbody>
<tr>
<td>Protocol List</td>
<td>HTTP</td>
</tr>
<tr>
<td>API Endpoint URL</td>
<td><p>Energy/1</p>
<p>この値以外の設定した場合は、API呼び出し時に指定した値を使うようにしてください。</p></td>
</tr>
</tbody>
</table>

#### サービス・リクエストの構成

サービス・リクエストはバックエンド・サービスがリクエストを受け取るURLです。リクエストがすべてのポリシーの条件を満たす場合、ゲートウェイはリクエストをこのURLにルーティングし、サービスを呼び出します。

サービス・リクエスト URLは、そのベースURLだけではなく、任意のサービスのリソースを指すことができます。そのため、ユーザーがAPIリソースのサブセットだけにアクセスするよう制限することができます。

以下の手順に従って、サービス・リクエストを構成します。

1. サービス・リクエスト Policyをマウスでホバーリングし、Editをクリック

    ![image4](./media/image4.png)

2. Apply Policyダイアログで以下のように設定し、［Apply］をクリック

| Backend Service URL |
| --------------------------------------------------------------------------------------------- |
| [http://eserv1.oracle.com:7777](http://eserv1.oracle.com:7777) |

3. ［Save Changes］をクリック

#### レスポンス・フロー

ここまでで、APIリクエストとサービス・リクエストをRequestセクションに登録しましたが、Responseフローセクションもあります。Responseタブをクリックすると、レスポンスフローが表示されます。Service ResponseとAPI Responseは編集できません。

まずService Responseが発生します。バックエンド・サービスからのレスポンスは常にアウトバウンド・フローの最初のエントリです。このフローにポリシーを追加することができます。並んでいるポリシーを上から順に実行していき、最終的にレスポンスがクライアントに返されます。

API Responseエントリは、レスポンスがクライアントに戻る際のアウトバウンド・フローのポイントです。

    ![image5](./media/image5.png)

#### ゲートウェイへのAPIのデプロイ

APIのデプロイの詳細は後で説明しますが、まずは、作成したAPIをProduction ゲートウェイにデプロイしてみましょう。デプロイメントが成功すると、APIはリクエストをエンドポイントで受け付け、バックエンド・サービスにリクエストを正しくルーティングします。

以下の手順に従って、APIをデプロイします。

1. 左側のナビゲーションで上から2個目のDeploymentsタブをクリック

    ![image6](./media/image6.png)

2. [Deploy API]をクリック
3. **Production ゲートウェイ**を選択
4. **Initial Deployment State**は**Active**を選択
5. （オプション）必要に応じて、Descriptionに説明を記載
6. [Deploy]をクリック

    > ［注意］
    >
    > 数秒後にAPIがDeployedタブに現れてから、ページをリフレッシュしなければならない可能性があります。
    >
    > ![image7](./media/image7.png)
    >
    > ![image8](./media/image8.png)

このタスクでは、Initial Deployment StateをActiveに指定しています。これはAPIをデプロイするとすぐにActiveになり、リクエストの受信が可能になることを意味します。Inactiveの状態でデプロイすると、APIの状態をActiveにするまでAPIはリクエストを受け付けることはありません。この制御は、APIを有効化する前にデプロイメントの成功を確認したい場合や、後でAPIを有効化したい場合に役に立ちます。

#### デプロイ済APIの呼び出し

APIをデプロイしたので、呼び出してみましょう。

このチュートリアルでは、Postmanを使ってAPIに送信することにします。Postmanをお持ちでない場合は、以下のURLからダウンロードできます。もちろんお気に入りのRESTクライアントを使ってもかまいません。

[http://www.getpostman.com](http://www.getpostman.com)

以下の情報を使って、デプロイしたAPIにリクエストを送信します。

| メソッド | リクエストURL |
| -------- | ---- |
|  GET | <ゲートウェイのURL>/Energy/1/usage/current/month/4859634 |

![image9](./media/image9.png)

現時点では何もポリシーを適用していないので、リクエストはバックエンド・サービスに渡され、以下のスクリーンショットのようなレスポンスを受け取るはずです。後でポリシーを追加して別のリクエストをAPIに送信し、追加したポリシーの各々がリクエストを検証するようにします。

![image10](./media/image10.png)

### ポリシーの追加と構成

API Platform Cloud Serviceのポリシーには数多くの目的があります。APIに任意の件数のポリシーを適用して、APの保護、スロットリング、トラフィックの制限、ルーティング、ログ出力などを強制することができます。各ポリシー構成時に指定した条件に適わない場合には、適用されたポリシーに応じてAPIへのリクエストを拒否することができます。ポリシーはRequestタブやResponseタブでの並び順に従って実行されます。各ポリシーの設定できる箇所は決まっています。このチュートリアルでは、各ポリシーを構成時に配置すべき箇所を明示します。

このチュートリアルでは、以下のポリシーを適用します。

1. キー検証（APIキーのチェック）
2. アプリケーション・レート制限（アプリケーション単位での単位時間あたりの呼び出し回数を制限する）
3. ヘッダー検証（HTTPヘッダーをチェックする）
4. インターフェース・フィルタリング（インターフェースのブロック）
5. Resource Based Routing（リソースに基づいて呼び出し先を変える）
6. Service Callout（別のサービスを呼び出す）
7. Groovy Script（ゲートウェイでの処理をGroovy Scriptで記述する）

［注意］

キー検証とアプリケーション・レート制限の両ポリシーは、アプリケーションを作成し登録する必要があるため、この段階ではDraftとして適用します。アプリケーションの作成、登録は後ほど説明します。

#### キー検証ポリシーの追加

この章では、APIを利用しているアプリケーション開発者がアプリケーションにAPIを登録済みで、アプリケーションがRegisteredの状態であり、現在、正しいアプリケーション・キーを使っていることを保証するためのValidationポリシーをAPIに追加します。

キーを渡すために使用するHTTPヘッダーもしくはクエリ・パラメータを指定します。実行時に、キーがヘッダーやクエリ・パラメータにない場合、もしくはアプリケーションがRegisteredの状態でない場合、リクエストは拒否されます。キー検証ヘッダーがない、もしくはクエリ・パラメータがない場合、クライアントは400 Bad Requestエラーを受け取ります。正しいキーが渡されなければ、403を受け取ります。

このタスクはDraftポリシーとして適用する必要があります。Draftポリシーを使うと、完全な詳細実装を完了する前に実施したいことを検討することができます。これにより、より大きな絵を一気に書き上げつつ、後でAPIを完成させるために不足しているもののリマインダを残すことができます。APIデプロイ時、Draftポリシーはデプロイされませんので、後でこのポリシーを適用し、APIを再デプロイします。

以下の手順に従い、キー検証ポリシーを構成します。

1. API管理者ユーザーとして管理者ポータルにログインする

    ```bash
    <APIPCS URL>/APIplatform
    ```

    | ユーザー名 | パスワード |
    | ----- | ---------------------------------------- |
    | API-manager-user                         | welcome1                                 |

2. APIタブで、Energyをクリック
3. API Implementationタブをクリック
4. Available PoliciesでSecurityを展開し、キー検証の隣にあるApplyアイコンをクリック

    ![image11](./media/image11.png)

5. Apply Policyダイアログで以下の操作を実施する
    1. （オプション）必要であれば、説明と名前を入力する
    2. **Place Policy After**リストで**APIリクエスト**が選択されていることを確認
    3. **Header**タブをクリック
    4. **Header**に**API-key**と入力する。次のポリシー評価、もしくはサービス・リクエスト endpointに渡されるためには、**API-key**ヘッダーがリクエストに含まれている必要がある。
    5. **Apply as Draft**をクリック

    ![image12](./media/image12.png)

6. 画面右上部の**Save Changes**をクリック

    ［注意］Saveボタンを表示するためにブラウザ画面のスクロールが必要な場合があります。

#### アプリケーション・レート制限ポリシーの構成

この章では、アプリケーション・レート制限ポリシーを追加します。アプリケーション・レート制限ポリシーは単位時間あたりの各アプリケーションからのAPIへのリクエストを何件ルーティングするか、を制御するために利用します。このしきい値を超えると、ゲートウェイは後続のリクエストを拒否します。

このポリシーも、Draftポリシーとして適用します。チュートリアルの後で、ポリシーを適用し、APIを再デプロイします。

以下の手順に従って、アプリケーション・レート制限ポリシーを構成します。

1. 管理者ポータルに戻り、**API Implementation**タブをクリック
2. Available Policiesで、**Traffic Management**を展開し、Application　Rate Limitingをマウスでホバーリングし、**Apply**をクリック

    > ［注意］
    > 
    > アプリケーション・レート制限ポリシーとAPI Rate Limitポリシーは、異なる挙動を示すため、両者を混同しないように注意する。間違えた場合、このテキストに記載内容とは異なる結果に遭遇する可能性がある。
    > 
    > ![image13](./media/image13.png)

3. Apply Policyダイアログで以下のように指定する。
    1. （オプション）ポリシー名とDescriptionは必要であれば入力してもよい
    2. **キー検証**が**Place Policy After**リストで選択されていることを確認する
    3. Rate Limit per Applicationに10を指定する。これは、各単位時間あたりに通過するリクエストの件数である。
    4. Time IntervalのリストからMinuteを選択する。必要であれば、多くの条件を追加することができる。これは複数の時間間隔（秒、分、時間など）でリクエストの個数を制限したい場合に有効である。時間間隔ごとに別のRate Limitingポリシーを作成する必要はない。
    5. **Apply as Draft** をクリック

    ![image14](./media/image14.png)

4. 画面右上部の**Save Changes**をクリック

#### ヘッダー検証ポリシーの構成

この章では、ヘッダー検証ポリシーを追加します。これはリクエストとともに送信されたHTTPヘッダーの存在や値を検証するために利用します。このポリシーで定義した条件を満足しない場合、リクエストを拒否します。

以下の手順に従って、ヘッダー検証ポリシーを構成します。

1. Available Policiesで、Interface Managementを展開し、ヘッダー検証をマウスでホバーリングし、**Apply**をクリック

    > ［注意］
    >
    > ヘッダー検証とヘッダー検証 2は同じポリシーなので、どちらを使ってもよい。
    >
    > ![image15](./media/image15.png)

2. Apply Policyダイアログで以下のように指定する。

    1. （オプション）ポリシー名とDescriptionは必要であれば入力してもよい
    2. **アプリケーション・レート制限**が**Place Policy After**リストで選択されていることを確認する
    3. Header ConditionsのリストでPASSとANYを選択。これは、指定した条件のすべてを満足するHTTPヘッダーを含むリクエストをすべて通し、満足しない場合には拒否する。
        > ［注意］
        >
        > Apply Policyダイアログでリストから選択できない場合、ブラウザ画面をスクロールアップしてダイアログを画面上方に配置すること。
    4. Header Nameにtenant-idを指定
    5. Operatorは\>=を選択
    6. Valueには1を指定
    7. **Apply** をクリック
3. 画面右上部の **Save Changes** をクリック

    ![image16](./media/image16.png)

#### インターフェース・フィルタリングポリシーの構成

この章では、インターフェースをブロックするポリシーを構成します。これはリクエストで指定されたリソースやメソッドに基づいて、リクエストをブロックするために利用します。このチュートリアルでは、このポリシーを構成し、 **/usage/current/** （現在の計算期間での顧客の課金情報を返す）と、 **/estimate/** （顧客への次回請求金額の概算を返す）の2個のリソースに対するGETリクエストを通すようにします。他のメソッドを使ったリクエストや他のリソースに対するリクエストは拒否します。

以下の手順に従って、リソース・ベース・ルーティング・ポリシーを構成します。

1. Available Policiesで、Interface Managementを展開し、インターフェース・フィルタリングをマウスでホバーリングし、**Apply**をクリック

    ![image17](./media/image17.png)

2. Apply Policyダイアログで以下のように指定する。
    1. （オプション）ポリシー名とDescriptionは必要であれば入力してもよい
    2. **ヘッダー検証**が**Place Policy After**リストで選択されていることを確認
    3. **PASS**をリストから選択
    4. **/usage/current/\*** をResourcesに入力し、\[Enter\]を押す
    5. **/estimate/\*** をResourcesに入力し、\[Enter\]を押す
    6. Methodでは**GET**を選択
    7. **Apply**をクリック
3. 画面右上部の **Save Changes** をクリック

    ![image18](./media/image18.png)

#### リソース・ベース・ルーティング・ポリシーの構成

この章では、リソースベースのルーティングポリシーを構成します。これは特定のリソース・パスに対するリクエストを異なるサービスレスポンスURLにルーティングするために利用します。このポリシーを適用して2個のバックエンド・サービスを組み合わせます。一つは顧客の現在のエネルギー利用状況を返すサービス、もう一つは次回の課金時における顧客の予想使用量を返すというものです。これらのサービスからのレスポンスをアプリケーション開発者が利用する一つのインターフェースにまとめます。

以下の手順に従って、リソース・ベース・ルーティング・ポリシーを構成します。

1. Available Policiesで、Routingを展開し、Resource-Based Routingをマウスでホバーリングし、**Apply**をクリック

    ![image19](./media/image19.png)

2. Apply Policyダイアログで以下のように指定する。
    1. （オプション）ポリシー名とDescriptionは必要であれば入力してもよい
    2. **インターフェース・フィルタリング**が**Place Policy After**リストで選択されていることを確認する
    3. **Resource Path(s)**に**/estimate**を入力して\[Enter\]を押して条件を登録する。条件は複数登録することができるが、このチュートリアルでは1個のみ登録する。
    4. **Set サービス・リクエスト URL To**に以下のURLを入力する。
        ```bash
        http://eserv2.oracle.com:7778
        ```
        上記のリソース・パスのいずれかがリクエストに含まれている場合、APIのデフォルトのサービスリクエストURLではなく、このサービスリクエストURLにルーティングする。
    5. このチュートリアルでは、OTHERWISEにある**Keep Default サービス・リクエスト
        URL**を選択しているが、必要であれば、条件を満足しなかった場合のリクエストのデフォルトルーティング先を**Set サービス・リクエスト URL to**に指定したURLに変更することができる。
    6. **Apply** をクリック

        ![image20](./media/image20.png)

3. 画面右上部の**Save Changes**をクリック

#### サービス・コールアウト・ポリシーの構成

この章では、Request Flowから別のサービスを呼び出すサービス・コールアウト・ポリシーを構成します。受け取ったリクエストのペイロードを指定して、外部サービスの呼び出しが可能です。呼び出したサービスからのレスポンスに基づいて、リクエストを通したり、拒否したりすることができます。

このチュートリアルでは、別のエネルギー会社のサービスを呼び出します。このサービスはリクエスト・ペイロードの顧客番号を受け取って、顧客番号が存在すれば200を、存在しない場合は404を返します。顧客番号が存在しない場合、サービス・コールアウト・ポリシーは、バックエンド・サービスへのリクエストを拒否します。

このチュートリアルでは、ペイロードに顧客番号をハードコーディングしているので、このサービスへのCalloutは必ず成功しますが、現実世界のシナリオでは、Groovy Scriptを使って動的にこの顧客番号を判断する可能性があります。しかしながら、この方法はBetaではサポートしていません。

以下の手順に従って、サービス・コールアウト・ポリシーを構成します。

1. Available Policiesで、Otherを展開し、Service Calloutをマウスでホバーリングし、**Apply**をクリック

![image21](./media/image21.png)

2. Apply Policyダイアログで以下のように指定する。
    1. （オプション）ポリシー名とDescriptionは必要であれば入力してもよい
    2. **ヘッダー検証**が**Place Policy After**リストで選択されていることを確認
    3. リストで**PASS**と**Specific**が選択されていることを確認
    4. Status Code(s)に**200**を入力して**Enter**を押す
    5. MethodはPOSTを選択
    6. Server URLとして以下のURLを指定
        > [http://eserv2.oracle.com:7778/account](http://eserv2.oracle.com:7778/account)
    7. **Headers**で (+)をクリックし、フィールドに以下のヘッダー属性を指定。
        > Content-type:application/json
        > 
        > ［注意］
        > 
        > Beta 1ではHeadersの中にServiceという入力フィールドがありますが、ここにヘッダー属性を指定してください。
    8. Request Payloadとして以下のJSONデータを入力
        > ```json
        > {
        >     "account_number" : "4859634"
        > }
        > ```
    9. **Apply** をクリック
3. 画面右上部の**Save Changes**をクリック

    ![image22](./media/image22.png)

#### Groovy Scriptポリシーの構成

この章では、Groovy Scriptポリシーを追加します。これはGroovy Scriptで記述したロジックを使って、呼出コンテキスト（ヘッダー、クエリ・パラメータなど）の様相に基づいてリクエストの通過・拒否を判断します。

この章では、Groovy Scriptを使って、リクエストとともに送信されるContent-Typeヘッダーをチェックします。Content-Typeが付加されていない場合、application/jsonを追加します。チュートリアルをスムーズに進めるため、以下にスクリプトを記載してあります。

以下の手順に従って、Groovy Scriptポリシーを構成します。

1. Available Policiesで、Otherを展開し、Groovy Scriptをマウスでホバーリングし、**Apply**をクリック

    ![image23](./media/image23.png)

2. Apply Policyダイアログで以下のように指定する。
    1. （オプション）ポリシー名とDescriptionは必要であれば入力してもよい
    2. **Resource Based Routing**が**Place Policy After**リストで選択されていることを確認する
    3. 以下のスクリプトをコピーし、Groovy Scriptのフィールドにペーストする。
    4. **Apply**をクリック
3. 画面右上部の**Save Changes**をクリック

    ![image24](./media/image24.png)

ここまでの設定で、ポリシー構成は以下のようになっているはずです。

    ![image25](./media/image25.png)

------

## APIのデプロイ

この章では、ゲートウェイへのAPIのデプロイについて学びます。その中で、デプロイに必要なユーザー権限、特定の権限構成のための処理フロー、APIのアクティベートについて説明します。また、作成したAPIにリクエストを送信し、構成したポリシーが意図したとおりに機能していることを確認します。

この章では、以下の内容を取り扱います。

1. デプロイメントの権限
2. APIの再デプロイ
3. 現在デプロイ済のAPIの確認
4. APIの有効化・無効化
5. APIの呼び出し
6. APIのアンデプロイ

### デプロイメントの権限

API Platform Cloud Serviceにおける権限は、特定オブジェクトタイプのインスタンスに対応します。権限を特定のAPI、特定のゲートウェイ、などに割り当てることができます。例えば、Deploy APIという権限をAPIというタイプのオブジェクトにのみ与えることができ、ゲートウェイというタイプのオブジェクトに対して与えることはできません。インスタンス化すると、Deploy APIという権限のインスタンスは一つのAPIオブジェクトに対応します。

APIをデプロイするためには、API管理者sとゲートウェイ管理者sが特定の権限の組合せを有する必要があります。これらの組合せを使って、APIのデプロイメント・ワークフローを貴社のプロセスに合うようカスタマイズすることができます。なお、これらの権限はこのチュートリアル用にすでに作成済みなので、手作業で作成する必要はありません。

下表はAPIとゲートウェイの権限の組合せ、そしてこの権限の組合せで定まるAPIデプロイメントのワークフローをまとめたものです。1行目がこのチュートリアルで利用するワークフローです。

<table>
<thead>
<tr class="header">
<th>API管理者ロールが有する権限</th>
<th>ゲートウェイ管理者が有する権限</th>
<th>ワークフロー</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>APIの管理</p>
<p>ゲートウェイへのデプロイ</p></td>
<td>ゲートウェイの管理</td>
<td><p>API管理者はAPIを実装し、ゲートウェイにデプロイする。ゲートウェイへのデプロイ権限があるため、ゲートウェイ管理者からデプロイの承認を受ける必要なく、APIをデプロイできる。</p>
<p>ゲートウェイ管理者が受け取る、一つのバージョンのAPIを有効化、無効化、市デプロイ、アンデプロイするための暗黙の権限は、自身が所有するゲートウェイへのこのAPIのデプロイメントの間維持される。</p></td>
</tr>
<tr>
<td><p>APIの管理</p>
<p>ゲートウェイへのデプロイのリクエスト</p></td>
<td>ゲートウェイの管理</td>
<td><p>API管理者はAPIを実装し、特定のゲートウェイへのAPIのデプロイをリクエストする。API管理者にはゲートウェイへのデプロイのリクエストの権限ゆえ、APIをデプロイしようとするゲートウェイの所有者であるゲートウェイ管理者の承認が必要である。</p>
<p>ゲートウェイ管理者はデプロイ・リクエストを承認もしくは却下できる。ゲートウェイ管理者はゲートウェイとデプロイ済APIの管理も行う。</p></td>
</tr>
<tr>
<td>APIの管理</td>
<td>ゲートウェイの管理<br />
APIのデプロイ</td>
<td><p>API管理者はAPIを実装する。API管理者にはゲートウェイ に関する権限がないため、APIのデプロイならびにAPIデプロイのリクエストを出すことはできない。</p>
<p>ゲートウェイ管理者はゲートウェイとデプロイ済APIの管理を行う。</p>
<p>両者間のコミュニケーションは顧客が所有する外部システムでなされる。</p></td>
</tr>
</tbody>
</table>

### APIの再デプロイ

この章では、Production ゲートウェイへのデプロイ権限を持つAPI管理者の役回りでチュートリアルを進めます。デプロイ・リクエストは自動的に承認されるので、ゲートウェイ管理者に切り替えてデプロイ・リクエストを承認する必要はありません。すでにAPIをデプロイ済なので、APIをゲートウェイに再デプロイすると、先ほど作成したポリシーが有効になります。

［注意］

この処理フローは権限に依存します。異なる権限スキームを持つ環境では異なるフローで処理されます。

以下の手順に従ってAPIを再デプロイします。

1. **Deployments**タブをクリック
2. **Production ゲートウェイ**デプロイメントの上でマウスをホバーリングし、**Redeploy**をクリック
3. 確認のプロンプトが現れたら**Yes**をクリック

APIのデプロイメントは保留中です。APIのデプロイの権限はありますが、ゲートウェイ管理者がデプロイメントを承認する必要があるためです。デプロイメントは自動的にWaitingの状態に遷移します。これはデプロイメントが保留中であることを意味します。承認が必要な場合、ゲートウェイ管理者がデプロイ・リクエストを承認した後、デプロイ・リクエストはWaiting状態に遷移します。Waiting状態から、APIをゲートウェイにデプロイし、ゲートウェイによる次回のManagement ServiceのポーリングのタイミングでAPIへのリクエストの受付を開始します。ゲートウェイはManagement Serviceを定期的にポーリングします。デフォルトの時間間隔は120秒（2分）です。120秒後、状態はWaitingからDeployedに遷移し、この段階でAPIの再デプロイが完了します。

### 現在のデプロイ済APIの確認

ゲートウェイにAPIをデプロイしてあるので、デプロイ済APIの詳細を見て、APIリクエスト送信先のURL、APIに対して構成されたポリシー、サービスリクエストURLを確認することができます。これを使ってすでにゲートウェイにデプロイ済のAPI実装からの変更箇所を比較してください。

以下の手順に従って、デプロイ済APIを確認します。

1. Deploymentタブで、APIがProduction ゲートウェイにデプロイ済でアクティブになっていることを確認する。
2. Expand（Deploymentタブの右上部の矢印）をクリックすると、APIのリクエスト、レスポンスパイプラインを表示する。APIリクエストとサービスリクエストの詳細を確認できる。

    ![image26](./media/image26.png)

3. ヘッダー検証ポリシーの上をマウスでホバーリングすると、**View Policy**アイコンが現れ、このアイコンをクリックすると、ポリシーの設定が表示されるが、ここでは変更できない。ポリシーを変更する場合には、**API Implementations**タブで変更し、再デプロイする必要がある。

    ![image27](./media/image27.png)

4. Closeをクリックして、View Policyダイアログを閉じる。

### APIの有効化・無効化

APIをActiveな状態でデプロイしているので、チュートリアルで先ほど送信したリクエストは成功しました。一時的にリクエストを受け付けないようにしたい場合、APIをInactive状態に変更することができます。この場合、ゲートウェイにデプロイしただけの状態でとどまります。このチュートリアルではAPIを無効化する必要はありません。

ゲートウェイがManagement Serviceに対してポーリング後、APIの状態がInactiveに変わります。このAPIに対する新規リクエストは、APIの状態がInactiveになっているために拒否されます。リクエストを再度受信するためには、APIを再度Activeにする必要があります。

### 再デプロイ済APIの呼び出し

APIの実装、ゲートウェイへのデプロイ、ポリシーの実装、APIの再デプロイが成功したので、APIにリクエストを送信し、ポリシーが意図した通りに機能していることを確認します。

以前と同様、Postmanを使ってAPIにリクエストを送信します。別のRESTクライアントを使ってもかまいません。以下の手順に従ってAPIを呼び出します。

1. 以下の情報を使ってAPIにリクエストを送信する。

    | メソッド     | リクエストURL |
    | -------- | -------- |
    | GET | [http://APIcs.oracle.com:8001/Energy/1/usage/current/month/4859634](http://APIcs.oracle.com:8001/Energy/1/usage/current/month/4859634) |

    この呼び出しでは、Bad Requestメッセージを伴ってリクエストが拒否される。その理由は、ヘッダー検証ポリシーが有効化されているためである。
    1以上の値を持つ、tenant-idをHTTPヘッダーに付けておく必要がある。

2. tenant-idをHTTPヘッダーに付けて、再度リクエストを送信する。リクエストに対し、以下のようなレスポンスがある。

    ![image10](./media/image10.png)

3. 続いて、以下の情報でAPIにリクエストを送信する。

    | メソッド     | リクエストURL |
    | -------- | -------- |
    | GET | [http://APIcs.oracle.com:8001/Energy/1/usage/last/month/4859634](http://APIcs.oracle.com:8001/Energy/1/usage/last/month/4859634) |

    このリクエストはMethod not allowedメッセージを伴って拒否される。その理由は、インターフェース・フィルタリングポリシーでこのリソースに対するリクエストを拒否しているためである。このポリシーは、例えバックエンド・サービスが /usage/last/month でリソースを有しているとしても、 /usage/current/month/* と /estimate/* 以外のリソースへのリクエストを拒否する。

4. 続いて、以下の情報を使ってAPIにリクエストを送信する。

    | メソッド     | リクエストURL |
    | -------- | -------- |
    | GET |  [http://APIcs.oracle.com:8001/Energy/1/estimate/4859634](http://APIcs.oracle.com:8001/Energy/1/estimate/4859634) |

    バックエンド・サービスには /estimate リソースがないが、Resource Based Routingポリシーが /estimate リソースへのリクエストをチェックし、ポリシーで構成したように、当該リソースを持つサービスへルーティングするため、以下のようなレスポンスを受け取る。

    ![image28](./media/image28.png)

### APIのアンデプロイ

ベストプラクティスとして、リクエストを受け付けないAPIはゲートウェイからアンデプロイするべきです。DeploymentタブのAPIエントリからAPIをアンデプロイすることができます。ただし、このチュートリアルでは以後のチュートリアルを完了する上で、APIはゲートウェイにデプロイされていて、Active状態にしておく必要があります。そのため、APIをアンデプロイする必要はありません。

![image29](./media/image29.png)

## APIのドキュメンテーションとポータルへの公開

この章では、APIの詳細を開発者ポータルへ公開する方法を説明します。APIを公開した後、アプリケーション開発者はAPIを発見し、API利用のためにアプリケーションを登録することができます。APIの公開とデプロイの違いに注意してください。両者ともAPIを形成するものですが、公開（Publication）は、権限を持つ利用者に対してAPIを見えるようにすることで、当該API用のWebページを生成します。デプロイメント（Deployment）は2章で説明したようにAPIエンドポイントという実体を生成するものです。

この章では以下の内容を取り扱います。

1. APIポータルのURLの構成
2. 概要テキストの構成
3. ドキュメンテーション・ページの構成
4. コンテンツのプレビュー
5. 公開、再公開、公開停止

### APIポータルのURLの構成

APIを公開する場合、開発者は開発者ポータルを参照してAPIを発見、登録、利用します。公開されたAPIの各々には開発者ポータルに詳細のページがあり、このページには、APIの名前、バージョンといったAPIの基本情報が記載されています。また、APIの目的を説明する概要情報、APIの利用応報に関するドキュメントを含みます。

API管理者は、APIの詳細ページのURIパスを構成することができます。例えば、ベースの開発者ポータルのURLが [http://example.com:7201/developers/APIs/](http://example.com:7201/developers/APIs/) である場合、APIの詳細ページは [http://example.com:7201/developers/APIs/Energy](http://example.com:7201/developers/APIs/Energy) です。この名前は一意でなければなりません。パスには1個の / セグメントのみ必要です。

以下は、詳細ページのパスの具体例です。

```bash
http://example.com:7201/developers/APIs/Energy
```

以下のように、/ が複数入ることは許されていません。

```bash
http://example.com:7201/developers/APIs/Energy/1/
```

ユーザーは異なるバージョンのAPIの詳細を詳細ページで確認することができます。

以下の手順に従って、API詳細ページのURIパスを構成します。

1. 管理者ポータルに戻り、**Energy** APIのPublicationタブをクリックする。
2. API　Request Portal URLの[Click to enter portal name]をクリックする。すでにここに名前を指定している場合は、青字で表示される。この青字をクリックし、ポータル名の選択、編集が可能である。
3. **Energy**と入力する。
4. ［Save］をクリック

![image30](./media/image30.png)

### 概要テキストの構成

概要テキストは開発者ポータルのAPIの詳細ページの下部に表示されます。このテキストはAPIの機能および開発者が利用にあたって知っておくべき他の重要な情報を説明するために使います。概要テキストではHTML形式、Markdown形式をサポートしています。

概要テキスト（overview text）はAPIの説明（description）と同じではありません。後者は簡潔なものであるのに対し、前者は詳細を記載しておくべきもので、必要に応じて長く記載することができます。説明はAPI名の下に直接構成しますが、概要テキストは **General Information** タブの開発者ポータル Overview Textで構成します。

概要テキストの登録にあたっては、以下のいずれかの方法が利用できます。

- MarkdownファイルやHTMLファイルをローカルシステムからアップロード
- HTMLやMarkdownテキストを手入力
- HTMLリソースやMarkdownリソースを示すURLを指定

このチュートリアルでは、事前に作成済みのHTML形式の概要テキストファイル（htmloverview\_bootcamp.html）を使います。

以下の手順に従い、概要テキストを追加します。

1. **開発者ポータル API Overview**で、**HTML**をクリック
2. ダイアログで、**File** > **Choose File** をクリック
3. htmloverview_bootcamp.html を選択
4. **OK** をクリック
5. **Save Changes** をクリック

［注意］

**Choose File** を押すのではなく、ファイルのドラッグ＆ドロップでもアップロードできます。

![image31](./media/image31.png)

### ドキュメンテーション・ページの構成

ドキュメンテーション・テキストは前章で作成した概要テキストに非常に似ていますが、このテキストはAPIがサポートするリソースやメソッドを記述することを目的としています。概要テキストのように、HTML形式、Markdown形式のドキュメンテーションをサポートしており、ファイルのアップロード、手作業による入力、ドキュメンテーション・リソースへのURLを提供することが可能です。ドキュメンテーション・テキストは開発者ポータルのAPI詳細ページのDocumentationタブに表示されます。

HTMLやMarkdownに加え、API Platform Cloud ServiceではAPIary Cloud Serviceと統合しており、OpenAPI、API Blueprint、RAMLドキュメンテーションをサポートします。APIary Cloud Serviceは、これらのファイルを描画してインタラクティブなドキュメンテーション体験を提供します。さらに、APIary Cloud ServiceはAPIコンソールと、APIのデザイン、テストのために利用することができるmockサーバを提供しています。

APIary Cloud Serviceとの統合にはAPIary Cloud ServiceのTeamアカウントが必要で、かつProfessionalアカウントである必要があります。登録は以下のURLから可能です。

[https://APIary.io/](https://APIary.io/)

なお、このチュートリアルを実施する上で、APIary Cloud Serviceのサブスクリプション登録をする必要はありません。

APIary Cloud Serviceと統合すると、このチュートリアルで説明している内容に比べてよりセキュアかつ一貫性のある体験を提供することができますが、このチュートリアルでは、APIary Cloud Serviceを利用せずに、このチュートリアル用に事前作成済みのサンプル・ドキュメンテーション・ページをアップロードし、開発者ポータルに表示することにします。

以下の手順に従って、ドキュメンテーション・ページを構成します。

1. **Documentation**で、**HTML**をクリック
2. ダイアログで、**File** \> **Choose File** をクリック
3. doc\_sample.htmを選択
4. **OK** をクリック
5. **Save Changes** をクリック

![image32](./media/image32.png)

### コンテンツのプレビュー

API管理者には、開発者ポータルでAPIの詳細ページをプレビュー可能な特別な権限が与えられています。Publicationタブで変更、保存したタイミングで、Previewボタンをクリックすると詳細ページが開発者ポータルでどのように見えるかを確認することができます。この方法で、アプリケーション開発者に対してページを公開する前に、概要テキストとドキュメンテーションの出力結果を確認することができます。

これはオプションのタスクであり、試したい人だけ実施してください。公開前の必須タスクではありません。

![image33](./media/image33.png)

### 公開、再公開、公開取り消し

開発者がAPIを発見できるよう、開発者ポータルに公開する必要があります。以下の手順に従って、ドキュメンテーション・ページを構成します。

1. **Publish to Portal**をクリック

![image34](./media/image34.png)

APIの詳細ページが開発者ポータルで閲覧できるようになりました。アプリケーション開発者はAPIを発見、サブスクライブすることができます。

APIの説明、概要テキスト、ドキュメンテーションの更新を含め、Publicationページタブで変更する都度、最新の変更を開発者ポータルに反映するため再発行する必要があります。

［注意］

API Platform Cloud ServiceはAPIの履歴を保持せず、APIの現在のイテレーションのみを保持します。保存すると、APIへのアップデートが即時に発効します（公開、再公開、公開取り消しも同様です）。公開すると、直近に保存されたAPIバージョンの詳細情報が開発者ポータルに公開されます。

開発者ポータルでのAPIの公開を取り消すことができます。公開を取り消すと、アプリケーション開発者はAPIの発見、利用ができなくなります。リクエストはAPIが無効化、もしくはゲートウェイからアンデプロイされるまで、ゲートウェイで引き続き処理します。

------

## APIに対する権限

この章では、APIの管理権限を持つユーザー、APIの利用権限を持つユーザーを指定します。API Platform Cloud Serviceのオブジェクトに対するすべてのアクションは、権限（grant）を通じてユーザーに資格を付与します。この章では、APIオブジェクトに対する権限を説明し、設定していきます。

この章では以下の内容を取り扱います。

1. APIの管理 (Manage API)
2. API詳細情報の閲覧 (View API Details)
3. API 公開済み詳細情報の閲覧 (View API Public Details)
4. APIのデプロイ(2) (Deploy API)
5. アプリケーションの登録 (Register App)
6. アプリケーションの登録リクエスト (Request Register App)

### 管理

API管理権限はAPI管理者に対してのみ付与可能です。API作成者に自動的に付与されます。管理者にはこの権限を明示的に付与する必要はありません。

この権限は、API詳細の編集、APIのデプロイ、削除、他のAPI管理者に権限を付与する権利を、API管理者に対し付与します。

### 詳細情報の閲覧

API詳細確認の権限があると、API管理者、ゲートウェイ管理者は管理者ポータル、開発者ポータルの両方で、APIの詳細情報を読み取り専用で確認できます。詳細情報には以下の内容が含まれます。

- 一般的な情報
- 実装
- デプロイ済のエンドポイント
- ユーザー
- アプリケーション
- 分析

このチュートリアルでは、この権限はAPIの実装に関する詳細情報を確認できるエネルギー会社の別の従業員に付与されています。

### 公開済み詳細情報の閲覧

この権限はアプリケーション開発者に対して付与可能です。アプリケーション開発者はこの権限により、開発者ポータルのAPIの詳細ページを閲覧することができます。

この権限は、アプリケーション開発者が、開発したアプリケーションのAPIへの登録や登録リクエストを可能にするものではありません。アプリケーション登録権限はこの後紹介します。

### デプロイ

ゲートウェイ管理者への正式なリクエストがなくてもAPIをデプロイできるようにするため、APIを作成したAPI管理者に対しゲートウェイ管理者がAPIのデプロイ権限を付与します。

API管理権限を付与されているため、API管理者には自身が作成したAPIをデプロイする権限が既にありますが、他者が作成したAPIをデプロイできるよう、APIデプロイ権限をAPI管理者に与えることができます。

### アプリケーションの登録

アプリケーション登録権限を付与されたユーザーは、別のユーザーによる登録承認がなくても、アプリケーションをAPIに登録することができます。この権限はユーザーに対してAPIの閲覧権限も付与します。そのため、アプリケーション登録権限やアプリケーション登録リクエスト権限を付与する場合、個別にAPI閲覧権限を付与する必要はありません。

この権限はアプリケーション開発者に付与することができます。

以下の手順に従って、アプリケーション登録権限をアプリケーション開発者に付与します。

1. APIを選択
2. User Managementタブをクリック
3. Registerタブをクリックし、Add Granteeをクリック
4. [Choose Grantee]でapp-dev-userを入力して、[Enter]をクリック
5. app-dev-userを選択し、Addをクリック。ここまでの操作で、このユーザーアプリケーション登録権限が付与された。付与済みのユーザーの名前はRegister Appタブに表示される。

![image35](./media/image35.png)

### アプリケーション登録リクエスト

この権限はアプリケーション登録権限と類似しており、アプリケーション開発者もしくはAPI管理者に付与されます。この権限を付与されたユーザーは、アプリケーション登録を要求することだけが可能です。API管理者がリクエストを確認している間、APIを利用することはできません。実行時にこのアプリケーション・キーを使ってAPIに送信されたリクエストをキー検証ポリシーで承認できるよう、API管理者は、登録リクエストを承認する必要があります。

------

## API Catalog

開発者ポータルはAPIの発見、学習、アプリケーションでの利用登録ができるWebページで、APIのサブスクライブやAPI呼び出しに必要な情報を収集することができます。

開発者ポータルにアクセスすると、API Catalogページが表示されます。Portalに公開されたすべてのAPIがリスト表示されます。

この章では、以下の内容を取り扱います。

1. APIの発見
2. API Portal
3. API Portalのドキュメンテーション

### APIの発見

Portalに公開されたAPIのリストは非常にたくさんある場合、サブスクライブしたいAPIを探す方法にはいくつかの方法があります。APIをキーワードで検索することができるので、名前や説明に入っている単語でAPIを絞ることができます。複数の単語を入力すると、それらの単語のいずれかを含むすべてのAPIを拾い出すことができますが、すべての単語を含むAPIがリストの最初に出てきます。1個以上のキーワードをリストに適用した場合、ページ上部に表示されます。フィルターをリストに適用することもできます。APIをアルファベット順、新旧順に並べ替えることもできます。

このチュートリアルでも、引き続きapp-dev-userとして開発者ポータルにログインします。このユーザーにはApplication Developerロールが付与されているので、APIをカタログで確認することができ、登録承認を要求しなくてもアプリケーションにAPIを登録することができます。アプリケーション登録については後の章で取り扱います。

以下の手順に従って、開発者ポータルにログインします。

1. 現在の環境からログアウトする。もしくは別のブラウザ、プライベートウィンドウを使う。
2. 開発者ポータル [http://APIcs.oracle.com:7201/developers/](http://APIcs.oracle.com:7201/developers/) に以下の資格証明を使ってログインする。

    | ユーザー名 | パスワード |
    | ----- | ---------------------------------------- |
    | app-dev-user                         | welcome1                                 |

公開されたAPIのみがカタログに表示されています。まだ公開していない場合には、［4.5公開、再公開、公開取り消し］の内容を実施してAPIを公開してください。アプリケーション開発者はAPIの閲覧権限、もしくはこれらの権限を包含する別の権限を有している必要があります。app-dev-userに対し必要な権限は5.5アプリケーションの登録で付与済みです。

以下の手順に従って、APIをカタログで検索します。

1. API Catalogページの上部にあるSearchフィールドにEnergy、もしくは他のクエリ文字列を入力してEnterを押す。このクエリに一致するすべてのAPIが表示される。

    ![image36](./media/image36.png)

2. 結果をクリアするには、Searchフィールドの下の青色バー上にある**X**をクリックする。**Clear All**をクリックすると、すべての検索文字をクリアすることもできる。
3. **＋Filters**をクリックして、フィルターを追加する。API Statusの下に表示されるステータスにチェックを入れる。異なる状態を持つAPIを作成した場合には、様々な状態がこのフィルターリストに選択肢として現れる。

     ![image37](./media/image37.png)

4. **Clear All**をクリックして、すべてのフィルターをクリアする。
5. **Sort by**をクリックして、**Newest**をクリックする。
6. **Alphabetical**をクリックして、リストをアルファベット順に並べ替える。

    ![image38](./media/image38.png)

### API Portal

API CatalogでAPIを選択すると、当該APIの詳細ページが現れます。このページにはAPIに関する情報が表示されています。APIの状態（Beta、Released、Deprecatedなど）、API利用登録の可否、すでに登録済みのアプリケーション、承認待ちの登録リクエストなどを確認することができます。APIの基本機能を説明する概要テキストもまたこのページに表示されます。

### API Portalドキュメンテーション

Documentationタブには、API作成時にGeneral Informationタブで指定したドキュメンテーションリファレンスを埋め込んでいます。構成内容によって、ドキュメンテーションはこのフレーム内にWebサイトやテキストとして、もしくはAPIary上のドキュメンテーションとして表示されます。

------

## アプリケーションの作成と登録

API Platform Cloud Serviceは、アプリケーション登録を使ってどのユーザーがAPIを使う権限を有しているかを管理しています。各アプリケーションにはキーが割り当てられており、このキーをキー検証ポリシーで指定された方式で、HTTPヘッダーやクエリ・パラメータとしてリクエストに付けて渡します。キー検証ポリシーが有効化されている場合、正しい、登録されたAPIに対応する現在のアプリケーション・キーを持つリクエストのみが許容されます。このAPIに対するその他のリクエストは拒否されます。

この章では以下の内容を取り扱います。

1. アプリケーションの作成
2. アプリケーションのAPIへの登録
3. どのAPIにアプリケーションを登録したのか（アプリケーション開発者の立場）
4. どのアプリケーションがAPIに登録されているのか（API管理者の立場）
5. 別アプリケーションの登録
6. アプリケーション・キーの発見
7. Draft状態のポリシーの有効化
8. APIの再々デプロイ
9. APIの呼び出し
10. Postman Collectionを使ったリクエストの送信
11. アプリケーション登録の保留
12. 新しいアプリケーション・キーの再発行
13. アプリケーションのAPIからの登録解除

------

### アプリケーションの作成

API Platform Cloud Serviceでアプリケーションを作成するには複数の方法があります。

- アプリケーション開発者の場合
  - アプリケーションを開発者ポータルのMy Applicationから
  - API登録プロセス時
- API管理者の場合
  - 直接API管理者の画面から

アプリケーション・キーはアプリケーション作成時に生成されます。このキーはキー検証ポリシーで使われ、APIに登録済みのアプリケーションからのリクエストのみをゲートウェイが許可することを保証します。

このチュートリアルでは、すでにアプリケーション開発者として開発者ポータルにログイン済みなので、My Applicationページでアプリケーションを作成してから、APIにアプリケーションを登録することにします。

以下の手順に従って、My Applicationsページからアプリケーションを作成します。

1. 画面の右上部にあるMy Applicationsアイオンをクリックすると、My Applicationsページが表示される。

    ![image39](./media/image39.png)

2. New Applicationをクリックする。Create Applicationページが現れる。
3. Application NameとしてEnergyを入力する。必要であればDescriptionに自由入力する。
4. **Application Type**を選択する。
5. Contact Informationには、氏名、メールアドレスを入力する。必須項目に入力が完了すると、Saveが現れる。
6. **Save**をクリックする。アプリケーションがMy Applicationページに現れる。

    ![image40](./media/image40.png)

    ![image41](./media/image41.png)

------

### アプリケーションのAPIへの登録

アプリケーション開発者としてアプリケーションを作成したので、このアプリケーションを先ほど作成したAPIに登録します。すでにこのユーザーに対してAPIへのアクセス権限がありますので、アプリケーション登録を完了することができます。

以下の手順に従って、APIにアプリケーションを登録します。

    1. API CatalogでAPIを選択し、**Register**をクリック

    ![image42](./media/image42.png)

    2. 前章で作**成したアプリケー**ションを選択し、**Register API**をクリック

    > ［注意］
    >
    > **Edit this Application**をクリックすると、先ほど作成したアプリケーションの詳細を編集することができます。
    >
    ![image43](./media/image43.png)

このユーザーはAPI管理者からの承認がなくても直接アプリケーションをAPIに登録することができる権限を有しているため、このアプリケーションは自動的に登録されます。この権限がない場合、API管理者は登録リクエストを見た上で、API管理者は要求を承認するか、却下するかを判断します。

------

### アプリケーションで利用登録したAPIの確認

API PortalもしくはAPI CatalogでAPIを閲覧すると、どのアプリケーションがAPIに登録されているのかがわかります。

どのAPIに特定のアプリケーションが登録されているか、アプリケーションの詳細ページを見ることで確認できます。

![image44](./media/image44.png)

![image45](./media/image45.png)

------

### APIを利用登録したアプリケーションの確認

API管理者の観点で、APIにどのアプリケーションが登録されているのかを確認することもできます。API管理者はすべてのアプリケーション開発者がAPIの利用を登録したアプリケーションを確認できます。対して、アプリケーション開発者は、自身のアプリケーションがどのAPIに利用登録したか、しかわかりません。

API管理者は登録リクエストされたアプリケーション、保留された登録リクエスト、以前の却下された登録リクエストを確認することができます。

管理者ポータルに戻ってAPI-manager-userでログインし、APIを選択すると、APIに関する上記情報のすべてを確認することができます。Registrationタブをクリックすると、Registered（登録済み）タブをデフォルトで表示します。ここには、以前の章で作成し、API利用登録したアプリケーションが表示されています。アプリケーションを展開すると、アプリケーション・キー、詳細、要求データと承認データを確認することができます。

![image46](./media/image46.png)

app-dev-userにRequest Register（アプリケーション登録リクエスト）の権限が付与されている場合、アプリケーション登録は自動的に承認されないので、アプリケーションはRequesting Registrationのタブに表示されます。API管理者はアプリケーション登録の承認をする必要があります。

APIへのアプリケーション登録状態もまた、キー検証ポリシーでの評価対象です。ユーザーが正しいキーを渡したとしても、アプリケーションがRegistered（登録済）の状態でなければ、ポリシーがリクエストをブロックします。アプリケーション登録が保留されたり、登録解除されたりした場合には、正しいキーがあろうがなかろうが、リクエストを拒否します。

------

### Customer Mobile AppをAPIに登録

Customer Mobile Appというアプリケーションが既にハンズオン環境上にあります。この章では、アプリケーションを横断した分析を後の章でチェックするため、このアプリケーションでAPI利用を登録します。

以下の手順に従い、キー検証ポリシーを構成します。

1. API管理者ユーザーとして管理者ポータルにログインする

| URL      | ユーザー名 | パスワード |
| ----- | ------ | ---------------------------------- |
| http://APIcs.oracle.com:7201/APIplatform | API-manager-user | welcome1 |

2. APIタブで、**Energy**をクリック
3. **Registrations**タブをクリック
4. **Register Application**をクリック

    ![image47](./media/image47.png)

5. **Create new application**をクリック
6. **Customer Mobile App**を名前として入力
7. 必要であれば、その他の情報を登録
8. **Select Initial State**で**Registered**が選択されていることを確認
9. **Register**をクリック

    ![image48](./media/image48.png)

------

### アプリケーション・キーの発見

登録済みアプリケーションに対応したキーを伴ってメッセージを送信しなければ、キー検証ポリシーで保護されているエンドポイントへ送信されたリクエストは拒否されます。

後ほどアプリケーション毎にアナリティクス・メトリック集約するために、2個のアプリケーション・キーを使ってリクエストを送信します。

以下の手順に従い、アプリケーションに紐付くアプリケーション・キーを発見します。

1. ここまでのタスクが完了した後、APIのRegistrationsタブをそのまま表示しているはずだが、他の画面を表示している場合は、APIタブをクリックし、**Energy**をクリック、**Registrations**タブをクリック
2. **Customer Mobile App**をクリックし、このアプリケーションの詳細を展開
3. **App Key**の値（例：6de96a10-6679-446e-88c7-41239a74fec6）をコピーしておく
4. Energyをクリックし、このアプリケーションの詳細を展開
5. **App Key**の値をコピーしておく

ここまでで、2個のアプリケーション・キーを収集することができました。

![image49](./media/image49.png)

------

### Draft状態のポリシーを有効化

この章では、Draft状態のポリシーであるキー検証とアプリケーション・レート制限を有効化します。これらのポリシーは、リクエストを通すためにアプリケーション・キーが必要であるため、このチュートリアルでは、現時点まで、適用されたこうしたポリシーを使ってAPIを呼び出すことはできませんでした。

以下の手順に従い、ポリシーを適用します。

1. API管理者ユーザーとして管理者ポータルにログイン
2. APIタブで、Energyをクリック
3. API Implementationタブをクリック
4. キー検証ポリシーの上をマウスでホバーリングし、**Edit**アイコンをクリック

    ![image50](./media/image50.png)

5. ダイアログの最下部にある、**Apply**をクリック

    ![image51](./media/image51.png)

6. アプリケーション・レート制限ポリシーの上をマウスでホバーリングし、**Edit**をクリック
7. ダイアログの最下部にある、**Apply**をクリック
8. **Save Changes**をクリック

------

### APIの再々デプロイ

キー検証ポリシーやアプリケーション・レート制限ポリシーを有効化したので、APIを再々デプロイする必要があります。

以下の手順に従い、APIを再々デプロイします。

1. **Deployments**タブをクリック
2. **Production ゲートウェイ**の上をマウスでホバーリングし、**Redeploy**をクリック
3. 確認メッセージが現れるので、**Yes**をクリック

    ![image52](./media/image52.png)

> ［注意］
>
> APIがDeployedタブに表示されるまでに数秒かかります。表示が更新されない場合、ページのリロードが必要になる場合があります。

------

### 登録済みアプリケーションとしてのリクエスト送信

アプリケーションを作成し、アプリケーション・キーを収集したので、ポリシーが想定通りに動作することを確認するため、APIにリクエストを送信します。

以前と同様、Postmanを使ってAPIにリクエストを送信します。もちろん、別のRESTクライアントを使ってもかまいません。以下の手順に従って、APIを呼び出します。

1. 以下の情報を使ってAPIにリクエストを送信する。

|           |                                                                                                                                                                             |
| --------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| メソッド      | GET                                                                                                                                                                         |
| リクエストURL  | ```http://APIcs.oracle.com:8001/Energy/1/usage/current/month/4859634``` |
| tenant-id | 1以上の数値                                                                                                                                                                      |

この呼び出しでは、リクエストが拒否されるが、その理由は、キー検証ポリシーが有効化されているためである。HTTPヘッダーにAPI-keyを設定する必要がある。

![image53](./media/image53.png)

2. PostmanのHeaderタブにAPI-keyを追加し、7.6アプリケーション・キーの発見で収集したアプリケーション・キーを値として貼り付ける。

> ［注意］
>
> 当然ながら、別のRESTクライアントを使っている場合には設定方法が異なる
>
> ![image54](./media/image54.png)

3. **Send**をクリックする。リクエストが成功し、以下のようなレスポンスが返ってくることを確認する。

![image10](./media/image10.png)

4. 少なくとも10回以上Sendをクリックする。11回目の送信以後、アプリケーション・レート制限ポリシーにより、単位時間（今回の場合は1分間）での最大リクエスト件数を超えたことを理由に、以下のメッセージとともにリクエストを拒否する。

> 別のアプリケーションからのリクエストは成功する（別のアプリケーション・キーを使って試すこと）。次章で、Postman collectionが2個のアプリケーション・キーを送信する作業を実施するので、この挙動を確認することができる。

------

### Postman Collectionを使ったリクエストの送信

この章では、数多くのリクエストをAPIにリクエスト送信をシミュレートするためPostman Collectionを使うことにします。コレクションは、異なる興味深い分析データを作成するにあたってリクエスト各々に対し手作業で修正する必要なく自動化してくれるものです。コレクションには2個のアプリケーションに対するリクエストが含まれています。ヘッダー検証、インターフェース・フィルタリング、アプリケーション・レート制限の各ポリシーで拒否されるリクエストと、別々の2個のリソースに対する成功するリクエストです。

異なるホスト名、API名、アプリケーション・キーを構成するため、Postmanの環境機能を使って、Request URLとHTTPヘッダーの文字列を環境固有の値に置き換えます。

Postmanを使っていない場合にはこの章をスキップしてもかまいませんが、このチュートリアルの分析の章で情報が不足することにご注意ください。

以下の手順に従って、コレクションを構成します。

------

#### Postmanでの環境設定

1. Postmanで、EnvironmentリストからManage Environmentsを選択

    > ![image55](./media/image55.png)

2. Addをクリック
3. Environment NameにAPICS-Betaと入力
4. 以下のKey-Valueのペアを登録

    <table>
    <thead>
    <tr class="header">
    <th>Key</th>
    <th>Value</th>
    </tr>
    </thead>
    <tbody>
    <tr>
    <td>server</td>
    <td>APIcs.oracle.com:8001</td>
    </tr>
    <tr>
    <td>API</td>
    <td>APIリクエスト・エンドポイントを指定<br />
    （例）Energy/1</td>
    </tr>
    <tr>
    <td>key1</td>
    <td>アプリケーションEnergyのアプリケーション・キー</td>
    </tr>
    <tr>
    <td>key2</td>
    <td>アプリケーションCustomer Mobile Appのアプリケーション・キー</td>
    </tr>
    </tbody>
    </table>

    ![image56](./media/image56.png)

5. **Add**をクリックした後、Manage Environmentsダイアログの外側をクリックして、このダイアログを閉じる

------

#### Collectionの実行

1. **Runner**をクリック
2. API Platform HOL Requestsコレクションを選択
3. Environmentリストから自分の環境を選択
4. Start Testをクリック

PostmanのResultsパネルは下図のような表示になっていれば（HTTPステータスコードに十分注意してください）、実行は成功しています。テストは実行していませんので、0 passed 0 failedと表示されているはずです。表示が明らかにおかしい場合は、Postmanの環境設定を確認してください。

![image57](./media/image57.png)

リクエストが完了すると、分析サービスが結果を集計します。

------

### アプリケーション登録の保留

キー検証ポリシーは、アプリケーションがRegisteredの状態であることを求めています。アプリケーション登録が保留の状態であれば、このAPIに対するすべてのリクエストが拒否されます。試してみたい方は、このアプリケーションの登録を保留にして、リクエストを送信してみてください。

> （ヒント）
>
> ApplicationのRegisteredタブでSuspend（保留）にすることができます。
>
> APIとアプリケーションのコントラクトが壊れているので、すべてのリクエストが拒否されます。アプリケーションの再登録をして初めてこのコントラクトが復旧します。
>
> アプリケーションを保留にする場合、次章に進む前に登録を再度承認することを忘れないでください。

------

### 新しいアプリケーション・キーの再発行

アプリケーション・キーが汚損された場合、当該アプリケーションの新しいキーを再発行することができます。開発者ポータルの当該アプリケーションのページ、もしくはAPI管理者の画面でキーを再発行できます。

アプリケーション・キーはアプリケーション・レベルで確立されるので、アプリケーション・キーが変わると、キー検証ポリシーを適用している、アプリケーションが利用登録された全てのAPIに影響が及びます。これらのAPIに対するすべてのリクエストで、この新しいキーを使う必要があります。古いキーを使ったリクエストは拒否されます。キー検証ポリシーが適用されていないAPIの場合、リクエストを通すための正しいアプリケーション・キーは必要ないため、影響はありません。

> ![image58](./media/image58.png)
> 
> ![image59](./media/image59.png)

------

### アプリケーションのAPIからの登録解除

アプリケーションでAPIを使う必要がなくなった場合には、APIからアプリケーションを登録解除することができます。これは登録情報を削除することを意味します。この結果、キー検証ポリシーを強制しているAPIに対するすべてのリクエストが拒否されます。アプリケーションをAPIに再登録する場合、キーはAPIレベルではなく、アプリケーション・レベルで確立されるため、同じアプリケーション・キーが利用できます。

API管理者 UI（のAPIのApplicationタブ）と、開発者ポータル（のアプリケーション詳細ページ）のどちらからでもアプリケーションの登録解除が可能です。

ベストプラクティスとして、特定のAPIにて問題が発生した場合には、まずはアプリケーション登録を保留にすべきです。APIをもうアプリケーションで利用しないと判断した場合には、アプリケーションを登録解除すべきです。

------

## 分析

API Platform Cloud Serviceには分析機能が標準で備わっています。サービスが収集したデータを使い、APIの利用方法、APIの利用時期、APIの利用理由に対し価値ある洞察を得たり、リクエストの拒否回数ならびに拒否理由を確認したり、時系列でのトレンドを追跡したりすることができます。

API Platform Cloud Serviceの初期リリースでは、API、ゲートウェイ、アプリケーションといったオブジェクト毎の分析が可能です。組織レベルの分析は将来リリースで計画しています。

この章では以下の内容を取り扱います。

1. APIの分析
2. ゲートウェイの分析

------

### APIの分析

この章では、API管理者で利用可能な5個のグラフを確認し、API Platform Cloud Serviceの初期リリースで利用可能な追加グラフを説明します。

以下の手順に従って、APIの分析を確認します。

1. 管理者ポータルに戻り、APIのAnalyticsタブをクリック
2. まだ選択されていない場合には、Generalタブをクリック。Generalタブにはリクエスト件数（Request Volume）とレスポンス時間（Response Time）、ペイロードサイズ（Payload Size）、リソース毎のリクエスト（Requests by Resource）のグラフが表示される。別のグラフは、ApplicationsやErrors、Rejectionsタブで表示する。

![image60](./media/image60.png)

このページの時間コントロールを使って、特定期間のデータを抽出することができます。デフォルトでは、当日（0時から現在時刻まで）のデータが表示されます。**Last 24 Hours**（過去24時間）をクリックすると、現在時刻から過去24時間にさかのぼった期間のデータを表示します。異なる期間のデータを表示する場合には、以下のいずれかの方法を利用します。

    - current hour（現在の時間）やweek（週）、特定の月や年、last minute/hour（直近の分や時間）などといった、事前定義済みの時間間隔を**Other**リストから選択する
    - Otherリストの下にある時間間隔をクリックし、手入力で開始時間と終了時間、日時を指定する

その他に、ゲートウェイ毎にデータをフィルタリングできます。ゲートウェイsフィールドにAPIをデプロイしたゲートウェイの名前を入力できます。このフィールドからゲートウェイを削除すると、Analyticsタブからもデータが削除されます。Applicationsフィルターを使うと、APIの利用登録済みアプリケーションを指定すれば、当該アプリケーションからのリクエストに対するデータだけを絞り込むことができます。未登録のアプリケーションからのリクエストも収集できます。このリストで、Unknown Applicationsを選択すると、未登録のアプリケーションからのリクエストを確認することができます。

![image61](./media/image61.png)

時間やゲートウェイ、アプリケーションというこれらのフィルターは、Analyticsタブのすべてのデータに影響があります。

------

#### リクエスト件数のグラフ

リクエスト件数のグラフでは、ゲートウェイにデプロイされたAPIが受信したリクエスト件数を表示します。指定された時間での、すべてのリクエストを表示するグラフ、成功したリクエストのみ表示、拒否したリクエストのみ表示、エラーのリクエストのみ表示するグラフを構成することができます。

リクエスト件数のグラフはAPIが受信しているトラフィック、時系列でのリクエストのトレンド、拒否されたリクエストやその他のエラーの観点でトラフィックの全体的な状況に対する一般的な情報を提供します。

![image62](./media/image62.png)

#### レスポンス時間のグラフ

レスポンス時間のグラフは、選択されたAPIのリクエストからレスポンスまでのラウンドトリップの時間をミリ秒単位で表示します。時間範囲（灰色）は、指定された時間間隔でのレスポンス時間の最小値と最大値を示しています。当該時間間隔でのラウンドトリップ時間の中央値を青色で示しています。指定された時間帯で、呼び出し回数の幅、API層での所要時間、サービス層での所要時間の幅を表示することができます。

レスポンス時間のグラフはAPI
Managerに対しリクエストに対するレスポンス時間の幅や中央値、時系列におけるトレンド、API層とサービス層の間での所要レスポンス時間に関する情報を提供します。

![image63](./media/image63.png)

#### ペイロードサイズのグラフ

ペイロードサイズのグラフでは、各リクエストで送信されたペイロードのサイズを表示します。このグラフをフィルタリングして、リクエスト・レスポンスのペイロードのサイズを表示することができます。

1. レスポンス・ペイロードを伴うリクエストを送信しなかったので、Responseをクリックして、バックエンド・サービスから送信された、レスポンス・ペイロードのサイズを表示する

![image64](./media/image64.png)

#### リソース毎のリクエスト

リソース毎のリクエストの表はGeneralページの最下部にあり、サービスのリソースに対するリクエストの件数と分散を表示します。

この表では、チュートリアルで利用した以下の3個のエントリを表示します。各リソースについて、以下の情報を表示します。

| 1 | 2 | 3 |
| --------------------------- |
| usage/current/month/4859634 | usage/current/month/4859634 |estimate/4859634            |

    - 各リソースへのリクエストの総件数
    - リクエストの総件数に対する、各リソースへのリクエスト件数の割合
    - 各リソースへのリクエストにおける、ポリシーによって拒否されたリクエスト件数
    - 拒否されたリクエストの総件数に対する、各リソースへの拒否リクエスト件数の割合
    - 各リソースへのリクエストにおける、サービス・エラー件数
    - 総エラー件数に対する、サービス・エラーが発生した各リソースへのリクエスト件数の割合

    ![image65](./media/image65.png)

#### アプリケーションごとのリクエストのグラフ

Applicationsページをクリックすると、アプリケーションごとのリクエスト情報を表示します。

この表には、各リクエストを通したアプリケーション・キーを使って識別した、アプリケーション各々からのリクエストの件数とその分布が表示されています。この表では、チュートリアルで作成したアプリケーションとCustomer Mobile AppのAPI利用登録をした2個のアプリケーションのエントリを表示しています。各リソースについて以下の情報を表示します。

    - 各アプリケーションからのリクエストの総数
    - 各アプリケーションからのリクエスト件数の、総リクエスト件数に対する割合
    - 各アプリケーションからのリクエストのうち、ポリシーによって拒否されたリクエスト件数
    - 各アプリケーションからのリクエストのうち、拒否されたリクエスト件数の、拒否されたリクエスト件数の総数に対する割合
    - 各アプリケーションからのリクエストのうち、サービス・エラーが発生したリクエスト件数
    - 各アプリケーションからのリクエストのうち、サービス・エラーが発生したリクエスト件数の、エラー件数に対する割合

![image66](./media/image66.png)

エラーを受け取るべきではありませんし、これらの列は空白になっているべきです。他のアプリケーションからリクエストを送信すると、各アプリケーションに対するエントリがこの表に現れます。

#### 拒否リクエスト件数のグラフ

**Errors and Rejections**ページをクリックすると、拒否率のグラフが表示されます。

拒否率のグラフにはポリシーの条件に従いAPI呼び出しを拒否した件数を表示します。チュートリアル中に拒否されたリクエストを送信したので、このグラフにも拒否件数を示す棒グラフが表示されているはずです。

![image67](./media/image67.png)

このグラフを絞り込み。拒否リクエスト件数の総数や、リクエストフローやレスポンスフローに設定したポリシーによるリクエスト拒否の件数、バックエンド・サービスによる拒否件数を表示することができます。また、特定のポリシータイプからの拒否件数のみを表示することも可能です。Select a policyリストからヘッダー検証を選択すると、ヘッダー検証ポリシーによって拒否されたリクエスト件数のみ表示することができます。

#### 拒否リクエストの分布グラフ

拒否リクエストの分布グラフでは拒否されたリクエストの件数、分布を表示します。複数の拒否されるリクエストをチュートリアル中に送信しているので、このグラフに現れているはずです。

バグの回避のため、Show Policy Typesを選択して、全ポリシーによる拒否件数、Application Rate
Limitingポリシーによる拒否件数を表示する必要があります。

![image68](./media/image68.png)

このグラフを絞り込み、拒否リクエストの総数、リクエストフロー中のポリシーによる拒否件数、レスポンスフロー中のポリシーによる拒否件数、バックエンド・サービスによる拒否件数を表示することができます。**Show Policy Types**を選択すると、各ポリシータイプに対する拒否件数を表示します。**Show Policy Instances**を選択すると、ポリシーの各インスタンスからの拒否件数を表示します。例えば、複数のヘッダー検証ポリシーを使っている場合、Show Policy Typesを選択すると、全てのヘッダー検証ポリシーによって拒否されたリクエスト件数を1個のデータ点としてまとめてしまいますが、Show Policy Instancesを選択すれば、各ヘッダー検証ポリシーによる拒否リクエスト件数を別のデータ点として表示します。

#### その他の分析グラフ

API Platform Cloud Serviceでは以下のグラフも利用できます。

- **エラー率（Error Rate）**

    API毎の時間あたりの総エラー件数およびその割合を表示します。このグラフを絞り込んで、すべてのエラー、ポリシーでのエラー、サービスでのエラー、その他特定のエラーを表示することができます。API管理者とゲートウェイ管理者はこのグラフを使って、エラー件数の総数やリクエストの件数に対するエラーが発生したリクエスト件数の割合を確認することができます。

- **エラー分布（Error Distribution）**

    エラー発生件数、ならびにAPI毎のエラー件数の割合を表示します。このグラフを絞り込んで、全エラー件数、ポリシーでのエラー件数、サービスでのエラー件数を表示することができます。API管理者とゲートウェイ管理者はこのグラフを使って、どこで各エラーが発生しているのかを確認することができます。

- **APIごとのリクエスト（Request by API）**

    ゲートウェイで収集した以下の情報を表示します。
        - API名
        - リクエスト件数
        - 全リソースの総リクエスト件数に対する、当該APIでのリクエスト件数の割合
        - 拒否リクエスト件数
        - 全拒否リクエスト件数に対する、当該APIでの拒否件数の割合
        - エラー件数
        - 全エラー件数に対する当該APIでのエラー件数の割合

    ゲートウェイ管理者はこの情報を使って、どのAPIがゲートウェイに対するトラフィックを増やしているのかを確認することができます。

- **アプリケーション・エラー分布（Application Error Distribution）**

    API毎のエラーコード、エラー件数、総エラー件数に対する割合を表示します。アプリケーション開発者はこの情報を使って、自分たちのリクエストによって発生したエラーの分布を確認することができます。

- **アプリケーション・エラー率（Application Error Rate）**

    API毎のエラー件数、ならびに、全リクエスト件数に対するエラー件数の割合を表示します。このグラフを絞り込んで、すべてのエラーや特定のエラーの情報を確認することができます。アプリケーション開発者はこの情報を使って、時間あたりの、リクエストやアプリケーション毎のエラー件数を確認することができます。

------

### ゲートウェイの分析

API Platform Cloud Serviceのこのバージョンでは、ゲートウェイ Analyticsタブで利用可能なグラフはAPI Analyticsタブにあるものと同じです。両者の違いは、ゲートウェイ Analyticsタブで表示されるデータは、（フィルターを適用していなければ）ゲートウェイにデプロイされた全てのAPIの情報ですが、API Analyticsタブで表示されるデータは、選択されたAPIのみの情報、という点です。

以下の手順に従い、ゲートウェイにデプロイされた全てのAPIに対する分析を表示します。

1. **ゲートウェイs**タブをクリック
2. **Production ゲートウェイ**をクリック
3. **Analytics**タブをクリック

![image69](./media/image69.png)
