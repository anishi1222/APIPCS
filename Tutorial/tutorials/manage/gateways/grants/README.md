# ゲートウェイ上のアクセスGrantの管理

ゲートウェイはAPIが実際に動作する場所です。*Gateway Manager*ロールを持つユーザーが主としてゲートウェイの監視と管理を担当します。堅牢な権限付与システムにより、API Platform Cloud Serviceはゲートウェイへのアクセスを管理します。権限によって、ユーザーまたはユーザーのグループがゲートウェイの表示、更新、デプロイまたはデプロイメント・リクエストを実行できるかがきまります。*Gateway Manager*ロールを持つユーザーが特定のゲートウェイを管理できるかどうかも権限によって制御されます。

## 始める前に

> 注意：共有環境またはテナントを使用している場合は、いずれのゲートウェイにも必要な権限が与えられていない可能性があります。適切な権限がない場合は、管理者に連絡するか、管理者である環境オプションのいずれかを選択してください。

### 前提条件

- 利用可能なAPI Platform Cloud Service環境を有している必要があります。API Platform Cloud Service環境の調達の詳細については、[環境](../../../../../environments/README.md)を参照してください。
- ご利用の環境に少なくとも1つのゲートウェイがデプロイされており、ユーザーに*ゲートウェイの管理*権限が与えられている必要があります。
- 演習開始時点でゲートウェイへのアクセス権限のない*API Manager*ユーザーがある必要があります。

### オプション

- *ゲートウェイへのデプロイ*または*ゲートウェイへのデプロイメントのリクエスト*権限付与をテストするには、APIを作成する必要があります。 APIをまだ作成していない場合は、[APIポリシー実装の作成](../../manage/create_api)演習を実行してAPIを作成できます。

## コンセプトチェック

1. *API Manager*ロールを持つユーザーとしてAPI Platform Cloud Service管理ポータルにログインします。
    - メニューに*ゲートウェイ*オプションが表示されてますか？
    - *ゲートウェイ*を選択すると、ゲートウェイがリスト表示されますか？
    - *ゲートウェイ*が表示されている場合は、それらのゲートウェイにAPIをデプロイできますか？
    - *ゲートウェイ*が表示されない場合、存在しないことを意味しますか？

## ゲートウェイ権限の付与

1. *Gateway Manager*ロールを持つユーザーとしてAPI Platform Cloud Serviceにログインします。 [環境](../../../../environments/README.md)を参照してください。
1. Developmentゲートウェイ（またはデプロイした任意のゲートウェイ）を選択します。
1. *Grants*タブをクリックします。
1. すべての権限を確認してください。各権限について、その権限を割り当てられたユーザーのリストを表示するには、ヘッダータブをクリックします。
   - ゲートウェイの管理：この権限が付与されたGateway Managerのユーザーは、このゲートウェイへのAPIのデプロイメントを管理し、ゲートウェイ自体を管理できます。
   - すべての詳細の表示：この権限が付与されたAPIおよびGateway Managerのユーザーは、このゲートウェイに関するすべての情報を表示することができます。
   - ゲートウェイへのデプロイ：この権限が付与されたAPIおよびGateway Managerのユーザーは、このゲートウェイにAPIをデプロイまたはアンデプロイすることができます。
   - ゲートウェイへのデプロイメントのリクエスト：この権限が付与されたAPI Managerユーザーは、このゲートウェイへのAPIデプロイメントのリクエストを提出できます。リクエストはゲートウェイマネージャによって承認される必要があります。
   - ノード・サービス・アカウント：ゲートウェイランタイムサービスアカウントには、このが付与され、構成のダウンロードと統計のアップロードが可能です。
1. 割り当てる権限名をクリックします。
    1. *権限受領者の追加*をクリックします。
    1. *権限受領者の追加*ダイアログが表示されます。
    1. *権限受領者の追加*ダイアログで、付与するユーザーまたはグループを選択します。複数のユーザーとグループを選択できます。
      - お勧め：*API Manager*ロールを持つユーザーを選択し、そのユーザーに*ゲートウェイへのデプロイメントのリクエスト*権限を付与します。

    > すでにこの権限を持つユーザーまたはグループは選択できません。 権限受領者の追加ダイアログでグレー表示されます。

1. *追加*をクリックします。ユーザーまたはグループには、選択したゲートウェイ権限が付与されます。

## 権限のテスト

1. *API Manager*ロールを持つユーザーとして管理ポータルにサインインします。
1. コンセプトチェックのステップを試してください。何が変わりましたか？
1. ゲートウェイへのAPIのデプロイをリクエストします。
   - あなたのリクエストの状態はどうですか？*リクエスト中*、*待機中*それとも*デプロイ済*ですか？

## デプロイメントを承認する

APIが*リクエスト中*状態である場合、*ゲートウェイへのデプロイ*権限を持つユーザーがリクエストをレビューして承認するまでデプロイされません。

1. *ゲートウェイの管理*または*ゲートウェイへのデプロイ*権限を持つユーザーとしてAPI Platform Cloud Serviceにログインします。
1. *ゲートウェイ*を選択します。
1. あなたのゲートウェイを選択します。
1. *デプロイメント*サイド・タブを選択します。
1. *リクエスト中*ヘッダー・タブを選択します。
1. リクエストの詳細を展開し、API実装を確認します。
1. 確認した結果問題がない場合は、リクエストにカーソルを移動し、*承認*ボタンをクリックします。
1. デプロイメントの承認に関するコメントを追加し、*はい*をクリックします。
1. *リクエスト中*から*待機中*、*デプロイ済*へのリクエストの状態遷移を確認してください。

## 結論

この演習では、次のことを学びました。

- 権限がどのようにゲートウェイへのアクセスを制御するか
- ユーザーに権限を割り当てる方法
  
## トラブルシューティング

環境によっては、異なる結果が生じることがあります。

- APIが*リクエスト中*状態に遷移しない
  - 現在のユーザーが*ゲートウェイの管理*または*ゲートウェイへのデプロイ*権限を持つ可能性があります。この場合、デプロイメントの状態が*待機中*から*デプロイ済*に遷移します。
- APIが*待機中*でとどまっている
  - ゲートウェイノードを確認します。
    - [ゲートウェイノードのインストール](../../configure/gateway/gateway_node)を参照してください。
- APIが*失敗*状態になった
  - 失敗したリクエストを展開してエラーを表示します。

## もっと詳しく知る

APIゲートウェイ権限の詳細については、[ゲートウェイ権限の管理](https://docs.oracle.com/en/cloud/paas/api-platform-cloud/apfad/managing-gateway-grants.html)を参照してください。
